{"parents": [{"link": "../../../", "title": "Module code"}], "title": "runhouse.rns.login", "body": "<h1>Source code for runhouse.rns.login</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">from</span> <span class=\"nn\">typing</span> <span class=\"kn\">import</span> <span class=\"n\">Dict</span><span class=\"p\">,</span> <span class=\"n\">List</span><span class=\"p\">,</span> <span class=\"n\">Optional</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">requests</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">typer</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">runhouse.globals</span> <span class=\"kn\">import</span> <span class=\"n\">configs</span><span class=\"p\">,</span> <span class=\"n\">rns_client</span>\n\n<span class=\"n\">logger</span> <span class=\"o\">=</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">getLogger</span><span class=\"p\">(</span><span class=\"vm\">__name__</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">is_interactive</span><span class=\"p\">():</span>\n    <span class=\"kn\">import</span> <span class=\"nn\">__main__</span> <span class=\"k\">as</span> <span class=\"nn\">main</span>\n\n    <span class=\"k\">return</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">main</span><span class=\"p\">,</span> <span class=\"s2\">&quot;__file__&quot;</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"login\"><a class=\"viewcode-back\" href=\"../../../../api/python/login/#runhouse.login\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">login</span><span class=\"p\">(</span>\n    <span class=\"n\">token</span><span class=\"p\">:</span> <span class=\"nb\">str</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">download_config</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">upload_config</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">download_secrets</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">upload_secrets</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">ret_token</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">interactive</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;Login to Runhouse. Validates token provided, with options to upload or download stored secrets or config between</span>\n<span class=\"sd\">    local environment and Runhouse / Vault.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        token (str): Runhouse token, can be found at https://www.run.house/account#token. If not provided, function will</span>\n<span class=\"sd\">            interactively prompt for the token to be entered manually.</span>\n<span class=\"sd\">        download_config (bool): Whether to download configs from your Runhouse account to local environment.</span>\n<span class=\"sd\">        upload_config (bool): Whether to upload local configs into your Runhouse account.</span>\n<span class=\"sd\">        download_secrets (bool): Whether to download secrets from your Runhouse account to local environment.</span>\n<span class=\"sd\">        upload_secrets (bool): Whether to upload local secrets to your Runhouse account.</span>\n<span class=\"sd\">        ret_token (bool): Whether to return your Runhouse token. (Default: False)</span>\n<span class=\"sd\">        interactive (bool): Whether to interactively go through the login flow. ``token`` must be provided to</span>\n<span class=\"sd\">            set this to False.</span>\n\n<span class=\"sd\">    Returns:</span>\n<span class=\"sd\">        Token if ``ret_token`` is set to True, otherwise nothing.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">all_options_set</span> <span class=\"o\">=</span> <span class=\"n\">token</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">any</span><span class=\"p\">(</span>\n        <span class=\"n\">arg</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span>\n        <span class=\"k\">for</span> <span class=\"n\">arg</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"n\">download_config</span><span class=\"p\">,</span> <span class=\"n\">upload_config</span><span class=\"p\">,</span> <span class=\"n\">download_secrets</span><span class=\"p\">,</span> <span class=\"n\">upload_secrets</span><span class=\"p\">)</span>\n    <span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span> <span class=\"ow\">is</span> <span class=\"kc\">False</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">token</span><span class=\"p\">:</span>\n        <span class=\"k\">raise</span> <span class=\"ne\">Exception</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;`interactive` can only be set to `False` if token is provided.&quot;</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span> <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">interactive</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">all_options_set</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">getpass</span> <span class=\"kn\">import</span> <span class=\"n\">getpass</span>\n\n        <span class=\"kn\">from</span> <span class=\"nn\">rich.console</span> <span class=\"kn\">import</span> <span class=\"n\">Console</span>\n\n        <span class=\"n\">console</span> <span class=\"o\">=</span> <span class=\"n\">Console</span><span class=\"p\">()</span>\n        <span class=\"n\">console</span><span class=\"o\">.</span><span class=\"n\">print</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">            ____              __                             @ @ @</span>\n<span class=\"sd\">           / __ \\__  ______  / /_  ____  __  __________     []___</span>\n<span class=\"sd\">          / /_/ / / / / __ \\/ __ \\/ __ \\/ / / / ___/ _ \\   /    /\\____    @@</span>\n<span class=\"sd\">         / _, _/ /_/ / / / / / / / /_/ / /_/ (__  )  __/  /_/\\_//____/\\  @@@@</span>\n<span class=\"sd\">        /_/ |_|\\__,_/_/ /_/_/ /_/\\____/\\__,_/____/\\___/   | || |||__|||   ||</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">account_url</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;dashboard_url&#39;</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s2\">/account#token&quot;</span>\n        <span class=\"n\">link</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"sa\">f</span><span class=\"s2\">&quot;[link=</span><span class=\"si\">{</span><span class=\"n\">account_url</span><span class=\"si\">}</span><span class=\"s2\">]</span><span class=\"si\">{</span><span class=\"n\">account_url</span><span class=\"si\">}</span><span class=\"s2\">[/link]&quot;</span>\n            <span class=\"k\">if</span> <span class=\"n\">is_interactive</span><span class=\"p\">()</span>\n            <span class=\"k\">else</span> <span class=\"n\">account_url</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">token</span><span class=\"p\">:</span>\n            <span class=\"n\">console</span><span class=\"o\">.</span><span class=\"n\">print</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;Retrieve your token :key: here to use :person_running: :house: Runhouse for &quot;</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;secrets and artifact management: </span><span class=\"si\">{</span><span class=\"n\">link</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">style</span><span class=\"o\">=</span><span class=\"s2\">&quot;bold yellow&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">token</span> <span class=\"o\">=</span> <span class=\"n\">getpass</span><span class=\"p\">(</span><span class=\"s2\">&quot;Token: &quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">download_config</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">download_config</span>\n            <span class=\"k\">if</span> <span class=\"n\">download_config</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n            <span class=\"k\">else</span> <span class=\"n\">typer</span><span class=\"o\">.</span><span class=\"n\">confirm</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Download config from Runhouse to your local .rh folder?&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">download_secrets</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">download_secrets</span>\n            <span class=\"k\">if</span> <span class=\"n\">download_secrets</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n            <span class=\"k\">else</span> <span class=\"n\">typer</span><span class=\"o\">.</span><span class=\"n\">confirm</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Download secrets from Vault to your local Runhouse config?&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">upload_config</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">upload_config</span>\n            <span class=\"k\">if</span> <span class=\"n\">upload_config</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n            <span class=\"k\">else</span> <span class=\"n\">typer</span><span class=\"o\">.</span><span class=\"n\">confirm</span><span class=\"p\">(</span><span class=\"s2\">&quot;Upload your local config to Runhouse?&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">upload_secrets</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">upload_secrets</span>\n            <span class=\"k\">if</span> <span class=\"n\">upload_secrets</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n            <span class=\"k\">else</span> <span class=\"n\">typer</span><span class=\"o\">.</span><span class=\"n\">confirm</span><span class=\"p\">(</span><span class=\"s2\">&quot;Upload your local enabled provider secrets to Vault?&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">token</span><span class=\"p\">:</span>\n        <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"s2\">&quot;token&quot;</span><span class=\"p\">,</span> <span class=\"n\">token</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">download_config</span><span class=\"p\">:</span>\n        <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">download_and_save_defaults</span><span class=\"p\">()</span>\n        <span class=\"c1\"># We need to fresh the RNSClient to use the newly loaded configs</span>\n        <span class=\"n\">rns_client</span><span class=\"o\">.</span><span class=\"n\">refresh_defaults</span><span class=\"p\">()</span>\n    <span class=\"k\">elif</span> <span class=\"n\">upload_config</span><span class=\"p\">:</span>\n        <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">load_defaults_from_file</span><span class=\"p\">()</span>\n        <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">upload_defaults</span><span class=\"p\">(</span><span class=\"n\">defaults</span><span class=\"o\">=</span><span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">defaults_cache</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"c1\"># If we are not downloading or uploading config, we still want to make sure the token is valid</span>\n        <span class=\"c1\"># and also download the username and default folder</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">defaults</span> <span class=\"o\">=</span> <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">download_defaults</span><span class=\"p\">()</span>\n        <span class=\"k\">except</span><span class=\"p\">:</span>\n            <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">(</span><span class=\"s2\">&quot;Failed to validate token&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"s2\">&quot;username&quot;</span><span class=\"p\">,</span> <span class=\"n\">defaults</span><span class=\"p\">[</span><span class=\"s2\">&quot;username&quot;</span><span class=\"p\">])</span>\n        <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"s2\">&quot;default_folder&quot;</span><span class=\"p\">,</span> <span class=\"n\">defaults</span><span class=\"p\">[</span><span class=\"s2\">&quot;default_folder&quot;</span><span class=\"p\">])</span>\n\n    <span class=\"n\">_convert_secrets_resource</span><span class=\"p\">()</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">download_secrets</span><span class=\"p\">:</span>\n        <span class=\"n\">_login_download_secrets</span><span class=\"p\">()</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">upload_secrets</span><span class=\"p\">:</span>\n        <span class=\"n\">_login_upload_secrets</span><span class=\"p\">(</span><span class=\"n\">interactive</span><span class=\"o\">=</span><span class=\"n\">interactive</span><span class=\"p\">)</span>\n\n    <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"s2\">&quot;Successfully logged into Runhouse.&quot;</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">ret_token</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">token</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_login_download_secrets</span><span class=\"p\">(</span><span class=\"n\">headers</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">runhouse</span> <span class=\"kn\">import</span> <span class=\"n\">Secret</span>\n\n    <span class=\"n\">secrets</span> <span class=\"o\">=</span> <span class=\"n\">Secret</span><span class=\"o\">.</span><span class=\"n\">vault_secrets</span><span class=\"p\">(</span><span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"n\">headers</span> <span class=\"ow\">or</span> <span class=\"n\">rns_client</span><span class=\"o\">.</span><span class=\"n\">request_headers</span><span class=\"p\">)</span>\n    <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">secrets</span><span class=\"p\">:</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">secret</span> <span class=\"o\">=</span> <span class=\"n\">Secret</span><span class=\"o\">.</span><span class=\"n\">from_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n            <span class=\"n\">download_path</span> <span class=\"o\">=</span> <span class=\"n\">secret</span><span class=\"o\">.</span><span class=\"n\">path</span> <span class=\"ow\">or</span> <span class=\"n\">secret</span><span class=\"o\">.</span><span class=\"n\">_DEFAULT_CREDENTIALS_PATH</span>\n            <span class=\"k\">if</span> <span class=\"n\">download_path</span><span class=\"p\">:</span>\n                <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;Loading down secrets for </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s2\"> into </span><span class=\"si\">{</span><span class=\"n\">download_path</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span>\n                <span class=\"n\">secret</span><span class=\"o\">.</span><span class=\"n\">write</span><span class=\"p\">()</span>\n        <span class=\"k\">except</span> <span class=\"ne\">ValueError</span><span class=\"p\">:</span>\n            <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;Was not able to load down secrets for </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s2\">.&quot;</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_login_upload_secrets</span><span class=\"p\">(</span><span class=\"n\">interactive</span><span class=\"p\">:</span> <span class=\"nb\">bool</span><span class=\"p\">,</span> <span class=\"n\">headers</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">Dict</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">runhouse</span> <span class=\"kn\">import</span> <span class=\"n\">Secret</span>\n\n    <span class=\"n\">local_secrets</span> <span class=\"o\">=</span> <span class=\"n\">Secret</span><span class=\"o\">.</span><span class=\"n\">local_secrets</span><span class=\"p\">()</span>\n    <span class=\"n\">provider_secrets</span> <span class=\"o\">=</span> <span class=\"n\">Secret</span><span class=\"o\">.</span><span class=\"n\">extract_provider_secrets</span><span class=\"p\">()</span>\n    <span class=\"n\">local_secrets</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">provider_secrets</span><span class=\"p\">)</span>\n    <span class=\"n\">names</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">local_secrets</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">())</span>\n\n    <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">names</span><span class=\"p\">:</span>\n        <span class=\"n\">resource_uri</span> <span class=\"o\">=</span> <span class=\"n\">rns_client</span><span class=\"o\">.</span><span class=\"n\">resource_uri</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n        <span class=\"n\">resp</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span>\n            <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">rns_client</span><span class=\"o\">.</span><span class=\"n\">api_server_url</span><span class=\"si\">}</span><span class=\"s2\">/resource/</span><span class=\"si\">{</span><span class=\"n\">resource_uri</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"n\">headers</span> <span class=\"ow\">or</span> <span class=\"n\">rns_client</span><span class=\"o\">.</span><span class=\"n\">request_headers</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">resp</span><span class=\"o\">.</span><span class=\"n\">status_code</span> <span class=\"o\">==</span> <span class=\"mi\">200</span><span class=\"p\">:</span>\n            <span class=\"n\">local_secrets</span><span class=\"o\">.</span><span class=\"n\">pop</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n            <span class=\"k\">continue</span>\n        <span class=\"k\">if</span> <span class=\"n\">interactive</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">False</span><span class=\"p\">:</span>\n            <span class=\"n\">upload_secrets</span> <span class=\"o\">=</span> <span class=\"n\">typer</span><span class=\"o\">.</span><span class=\"n\">confirm</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;Upload secrets for </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s2\">?&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">upload_secrets</span><span class=\"p\">:</span>\n                <span class=\"n\">local_secrets</span><span class=\"o\">.</span><span class=\"n\">pop</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">local_secrets</span><span class=\"p\">:</span>\n        <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;Uploading secrets for </span><span class=\"si\">{</span><span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">local_secrets</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s2\"> to Vault.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">secret</span> <span class=\"ow\">in</span> <span class=\"n\">local_secrets</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"n\">secret</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">save_values</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_convert_secrets_resource</span><span class=\"p\">(</span><span class=\"n\">names</span><span class=\"p\">:</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">headers</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"c1\"># Convert vault-only secrets to a resource to maintain backwards compatibility,</span>\n    <span class=\"c1\"># following secrets resource revamp</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">runhouse</span> <span class=\"kn\">import</span> <span class=\"n\">provider_secret</span><span class=\"p\">,</span> <span class=\"n\">Secret</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">runhouse.resources.secrets.utils</span> <span class=\"kn\">import</span> <span class=\"n\">_load_vault_secrets</span>\n\n    <span class=\"n\">secrets</span> <span class=\"o\">=</span> <span class=\"n\">names</span> <span class=\"ow\">or</span> <span class=\"n\">Secret</span><span class=\"o\">.</span><span class=\"n\">vault_secrets</span><span class=\"p\">(</span>\n        <span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"n\">headers</span> <span class=\"ow\">or</span> <span class=\"n\">rns_client</span><span class=\"o\">.</span><span class=\"n\">request_headers</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">secrets</span><span class=\"p\">:</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">resource_uri</span> <span class=\"o\">=</span> <span class=\"n\">rns_client</span><span class=\"o\">.</span><span class=\"n\">resource_uri</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n            <span class=\"n\">resp</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">rns_client</span><span class=\"o\">.</span><span class=\"n\">api_server_url</span><span class=\"si\">}</span><span class=\"s2\">/resource/</span><span class=\"si\">{</span><span class=\"n\">resource_uri</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"n\">headers</span> <span class=\"ow\">or</span> <span class=\"n\">rns_client</span><span class=\"o\">.</span><span class=\"n\">request_headers</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">resp</span><span class=\"o\">.</span><span class=\"n\">status_code</span> <span class=\"o\">!=</span> <span class=\"mi\">200</span><span class=\"p\">:</span>\n                <span class=\"n\">values</span> <span class=\"o\">=</span> <span class=\"n\">_load_vault_secrets</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n                <span class=\"n\">secret</span> <span class=\"o\">=</span> <span class=\"n\">provider_secret</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">values</span><span class=\"o\">=</span><span class=\"n\">values</span><span class=\"p\">)</span>\n                <span class=\"n\">secret</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n\n        <span class=\"k\">except</span> <span class=\"ne\">AttributeError</span><span class=\"p\">:</span>\n            <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;Was not able to load down secrets for </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s2\">.&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">continue</span>\n\n\n<div class=\"viewcode-block\" id=\"logout\"><a class=\"viewcode-back\" href=\"../../../../api/python/login/#runhouse.logout\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">logout</span><span class=\"p\">(</span>\n    <span class=\"n\">delete_loaded_secrets</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">delete_rh_config_file</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">interactive</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Logout from Runhouse. Provides option to delete credentials from the Runhouse config and the underlying</span>\n<span class=\"sd\">    credentials file. Token is also deleted from the config.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        delete_loaded_secrets (bool, optional): If True, deletes the provider credentials file. Defaults to None.</span>\n<span class=\"sd\">        delete_rh_config_file (bool, optional): If True, deletes the rh config file. Defaults to None.</span>\n<span class=\"sd\">        interactive (bool, optional): If True, runs the logout process in interactive mode. Defaults to None.</span>\n\n<span class=\"sd\">    Returns:</span>\n<span class=\"sd\">        None</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">runhouse.resources.secrets</span> <span class=\"kn\">import</span> <span class=\"n\">Secret</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">runhouse.resources.secrets.provider_secrets.ssh_secret</span> <span class=\"kn\">import</span> <span class=\"n\">SSHSecret</span>\n\n    <span class=\"n\">interactive_session</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"n\">interactive</span> <span class=\"k\">if</span> <span class=\"n\">interactive</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"n\">is_interactive</span><span class=\"p\">()</span>\n    <span class=\"p\">)</span>\n\n    <span class=\"n\">local_secret_names</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;secrets&quot;</span><span class=\"p\">,</span> <span class=\"p\">{})</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">())</span>\n    <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">local_secret_names</span><span class=\"p\">:</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">secret</span> <span class=\"o\">=</span> <span class=\"n\">Secret</span><span class=\"o\">.</span><span class=\"n\">from_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"ne\">ValueError</span><span class=\"p\">:</span>\n            <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">delete_provider</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n            <span class=\"k\">continue</span>\n\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">secret</span><span class=\"p\">,</span> <span class=\"n\">SSHSecret</span><span class=\"p\">):</span>\n            <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Automatic deletion for local SSH credentials file is not supported. &quot;</span>\n                <span class=\"s2\">&quot;Please manually delete it if you would like to remove it&quot;</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">continue</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">interactive_session</span><span class=\"p\">:</span>\n            <span class=\"n\">delete_loaded_secrets</span> <span class=\"o\">=</span> <span class=\"n\">typer</span><span class=\"o\">.</span><span class=\"n\">confirm</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;Delete credentials file for </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s2\">?&quot;</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">secret</span><span class=\"o\">.</span><span class=\"n\">in_vault</span><span class=\"p\">()</span> <span class=\"ow\">or</span> <span class=\"n\">secret</span><span class=\"o\">.</span><span class=\"n\">is_local</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"n\">delete_loaded_secrets</span><span class=\"p\">:</span>\n                <span class=\"n\">secret</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">(</span><span class=\"n\">contents</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">secret</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">()</span>\n                <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">delete_provider</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n    <span class=\"n\">local_secrets</span> <span class=\"o\">=</span> <span class=\"n\">Secret</span><span class=\"o\">.</span><span class=\"n\">local_secrets</span><span class=\"p\">()</span>\n    <span class=\"k\">for</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">secret</span> <span class=\"ow\">in</span> <span class=\"n\">local_secrets</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n        <span class=\"n\">secret</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">()</span>\n\n    <span class=\"c1\"># Delete token and username/default folder from rh config file</span>\n    <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"o\">=</span><span class=\"s2\">&quot;token&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"o\">=</span><span class=\"s2\">&quot;username&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"o\">=</span><span class=\"s2\">&quot;default_folder&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"n\">rh_config_path</span> <span class=\"o\">=</span> <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">CONFIG_PATH</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">delete_rh_config_file</span> <span class=\"ow\">and</span> <span class=\"n\">interactive_session</span><span class=\"p\">:</span>\n        <span class=\"n\">delete_rh_config_file</span> <span class=\"o\">=</span> <span class=\"n\">typer</span><span class=\"o\">.</span><span class=\"n\">confirm</span><span class=\"p\">(</span><span class=\"s2\">&quot;Delete your local Runhouse config file?&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">delete_rh_config_file</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Delete the credentials file on the file system</span>\n        <span class=\"n\">configs</span><span class=\"o\">.</span><span class=\"n\">delete_defaults</span><span class=\"p\">(</span><span class=\"n\">rh_config_path</span><span class=\"p\">)</span>\n        <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;Deleted Runhouse config file from path: </span><span class=\"si\">{</span><span class=\"n\">rh_config_path</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"s2\">&quot;Successfully logged out of Runhouse.&quot;</span><span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/runhouse/rns/login", "sidebars": ["about.html", "navigation.html", "relations.html", "searchbox.html", "donate.html"], "customsidebar": null, "alabaster_version": "0.7.13"}