{"parents": [{"link": "../../../../", "title": "Module code"}], "title": "runhouse.rns.hardware.cluster_factory", "body": "<h1>Source code for runhouse.rns.hardware.cluster_factory</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">typing</span> <span class=\"kn\">import</span> <span class=\"n\">List</span><span class=\"p\">,</span> <span class=\"n\">Optional</span><span class=\"p\">,</span> <span class=\"n\">Union</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">runhouse.rh_config</span> <span class=\"kn\">import</span> <span class=\"n\">rns_client</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.cluster</span> <span class=\"kn\">import</span> <span class=\"n\">Cluster</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.on_demand_cluster</span> <span class=\"kn\">import</span> <span class=\"n\">OnDemandCluster</span>\n\n\n<span class=\"c1\"># Cluster factory method</span>\n<div class=\"viewcode-block\" id=\"cluster\"><a class=\"viewcode-back\" href=\"../../../../../rh_primitives/cluster/#runhouse.cluster\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">cluster</span><span class=\"p\">(</span>\n    <span class=\"n\">name</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span>\n    <span class=\"n\">instance_type</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">num_instances</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">provider</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">autostop_mins</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">use_spot</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">image_id</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">region</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">ips</span><span class=\"p\">:</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">ssh_creds</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">dict</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">dryrun</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">load</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">True</span><span class=\"p\">,</span>\n<span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"n\">Cluster</span><span class=\"p\">,</span> <span class=\"n\">OnDemandCluster</span><span class=\"p\">]:</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Builds an instance of :class:`Cluster`.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        name (str): Name for the cluster, to re-use later on.</span>\n<span class=\"sd\">        instance_type (int, optional): Type of cloud instance to use for the cluster. This could</span>\n<span class=\"sd\">            be a Runhouse built-in type, or your choice of instance type.</span>\n<span class=\"sd\">        num_instances (int, optional): Number of instances to use for the cluster.</span>\n<span class=\"sd\">        provider (str, optional): Cloud provider to use for the cluster.</span>\n<span class=\"sd\">        autostop_mins (int, optional): Number of minutes to keep the cluster up after inactivity,</span>\n<span class=\"sd\">            or ``-1`` to keep cluster up indefinitely.</span>\n<span class=\"sd\">        use_spot (bool, optional): Whether or not to use spot instance.</span>\n<span class=\"sd\">        image_id (str, optional): Custom image ID for the cluster.</span>\n<span class=\"sd\">        region (str, optional): The region to use for the cluster.</span>\n<span class=\"sd\">        ips (List[str], optional): List of IP addresses for the BYO cluster.</span>\n<span class=\"sd\">        ssh_creds (dict, optional): Dictionary mapping SSH credentials.</span>\n<span class=\"sd\">            Example: ``ssh_creds={&#39;ssh_user&#39;: &#39;...&#39;, &#39;ssh_private_key&#39;:&#39;&lt;path_to_key&gt;&#39;}``</span>\n<span class=\"sd\">        dryrun (bool): Whether to create the Cluster if it doesn&#39;t exist, or load a Cluster object as a dryrun.</span>\n<span class=\"sd\">            (Default: ``False``)</span>\n<span class=\"sd\">        load (bool): Whether to load an existing config for the Cluster. (Default: ``True``)</span>\n\n<span class=\"sd\">    Returns:</span>\n<span class=\"sd\">        Cluster or OnDemandCluster: The resulting cluster.</span>\n\n<span class=\"sd\">    Example:</span>\n<span class=\"sd\">        &gt;&gt;&gt; # BYO Cluster</span>\n<span class=\"sd\">        &gt;&gt;&gt; gpu = rh.cluster(ips=[&#39;&lt;ip of the cluster&gt;&#39;],</span>\n<span class=\"sd\">        &gt;&gt;&gt;          ssh_creds={&#39;ssh_user&#39;: &#39;...&#39;, &#39;ssh_private_key&#39;:&#39;&lt;path_to_key&gt;&#39;},</span>\n<span class=\"sd\">        &gt;&gt;&gt;          name=&#39;rh-a10x&#39;)</span>\n\n<span class=\"sd\">        &gt;&gt;&gt; # On-Demand SkyPilot Cluster (OnDemandCluster)</span>\n<span class=\"sd\">        &gt;&gt;&gt; gpu = rh.cluster(name=&#39;rh-4-a100s&#39;,</span>\n<span class=\"sd\">        &gt;&gt;&gt;                  instance_type=&#39;A100:4&#39;,</span>\n<span class=\"sd\">        &gt;&gt;&gt;                  provider=&#39;gcp&#39;,</span>\n<span class=\"sd\">        &gt;&gt;&gt;                  autostop_mins=-1,</span>\n<span class=\"sd\">        &gt;&gt;&gt;                  use_spot=True,</span>\n<span class=\"sd\">        &gt;&gt;&gt;                  image_id=&#39;my_ami_string&#39;,</span>\n<span class=\"sd\">        &gt;&gt;&gt;                  region=&#39;us-east-1&#39;,</span>\n<span class=\"sd\">        &gt;&gt;&gt;                  )</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">config</span> <span class=\"o\">=</span> <span class=\"n\">rns_client</span><span class=\"o\">.</span><span class=\"n\">load_config</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">load</span> <span class=\"k\">else</span> <span class=\"p\">{}</span>\n    <span class=\"n\">config</span><span class=\"p\">[</span><span class=\"s2\">&quot;name&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">name</span> <span class=\"ow\">or</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;rns_address&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;name&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">config</span><span class=\"p\">[</span><span class=\"s2\">&quot;ips&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">ips</span> <span class=\"ow\">or</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;ips&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"c1\"># ssh creds should only be in Secrets management, not in config</span>\n    <span class=\"n\">config</span><span class=\"p\">[</span><span class=\"s2\">&quot;ssh_creds&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">ssh_creds</span> <span class=\"ow\">or</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;ssh_creds&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">config</span><span class=\"p\">[</span><span class=\"s2\">&quot;ips&quot;</span><span class=\"p\">]:</span>\n        <span class=\"k\">return</span> <span class=\"n\">Cluster</span><span class=\"o\">.</span><span class=\"n\">from_config</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">,</span> <span class=\"n\">dryrun</span><span class=\"o\">=</span><span class=\"n\">dryrun</span><span class=\"p\">)</span>\n\n    <span class=\"n\">config</span><span class=\"p\">[</span><span class=\"s2\">&quot;instance_type&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">instance_type</span> <span class=\"ow\">or</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;instance_type&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"n\">config</span><span class=\"p\">[</span><span class=\"s2\">&quot;num_instances&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">num_instances</span> <span class=\"ow\">or</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;num_instances&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"n\">config</span><span class=\"p\">[</span><span class=\"s2\">&quot;provider&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">provider</span> <span class=\"ow\">or</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;provider&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"n\">config</span><span class=\"p\">[</span><span class=\"s2\">&quot;autostop_mins&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"n\">autostop_mins</span>\n        <span class=\"k\">if</span> <span class=\"n\">autostop_mins</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n        <span class=\"k\">else</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;autostop_mins&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">config</span><span class=\"p\">[</span><span class=\"s2\">&quot;use_spot&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"n\">use_spot</span> <span class=\"k\">if</span> <span class=\"n\">use_spot</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;use_spot&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">config</span><span class=\"p\">[</span><span class=\"s2\">&quot;image_id&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"n\">image_id</span> <span class=\"k\">if</span> <span class=\"n\">image_id</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;image_id&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">config</span><span class=\"p\">[</span><span class=\"s2\">&quot;region&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">region</span> <span class=\"k\">if</span> <span class=\"n\">region</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;region&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n\n    <span class=\"n\">new_cluster</span> <span class=\"o\">=</span> <span class=\"n\">OnDemandCluster</span><span class=\"o\">.</span><span class=\"n\">from_config</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">,</span> <span class=\"n\">dryrun</span><span class=\"o\">=</span><span class=\"n\">dryrun</span><span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">new_cluster</span></div>\n</pre></div>", "current_page_name": "_modules/runhouse/rns/hardware/cluster_factory", "sidebars": ["sidebar-logo.html", "search-field.html", "sbt-sidebar-nav.html", "sbt-sidebar-footer.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.12", "author": "the Runhouse team \ud83c\udfc3\u200d\u2640\ufe0f\ud83c\udfe0", "theme_use_edit_page_button": false, "theme_search_bar_text": "Search the docs ...", "theme_show_toc_level": 1}