{"parents": [{"link": "../../../../", "title": "Module code"}], "title": "runhouse.resources.functions.aws_lambda_factory", "body": "<h1>Source code for runhouse.resources.functions.aws_lambda_factory</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">copy</span>\n<span class=\"kn\">import</span> <span class=\"nn\">importlib.util</span>\n<span class=\"kn\">import</span> <span class=\"nn\">inspect</span>\n<span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">import</span> <span class=\"nn\">warnings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">pathlib</span> <span class=\"kn\">import</span> <span class=\"n\">Path</span>\n<span class=\"kn\">from</span> <span class=\"nn\">typing</span> <span class=\"kn\">import</span> <span class=\"n\">Callable</span><span class=\"p\">,</span> <span class=\"n\">Optional</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">runhouse.resources.envs</span> <span class=\"kn\">import</span> <span class=\"n\">_get_env_from</span><span class=\"p\">,</span> <span class=\"n\">Env</span>\n<span class=\"kn\">from</span> <span class=\"nn\">runhouse.resources.functions.aws_lambda</span> <span class=\"kn\">import</span> <span class=\"n\">LambdaFunction</span>\n<span class=\"kn\">from</span> <span class=\"nn\">runhouse.resources.functions.function</span> <span class=\"kn\">import</span> <span class=\"n\">Function</span>\n\n<span class=\"n\">logger</span> <span class=\"o\">=</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">getLogger</span><span class=\"p\">(</span><span class=\"vm\">__name__</span><span class=\"p\">)</span>\n\n<span class=\"n\">CRED_PATH</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">Path</span><span class=\"o\">.</span><span class=\"n\">home</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s2\">/.aws/credentials&quot;</span>\n<span class=\"n\">SUPPORTED_RUNTIMES</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n    <span class=\"s2\">&quot;python3.7&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;python3.8&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;python3.9&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;python3.10&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;python3.11&quot;</span><span class=\"p\">,</span>\n<span class=\"p\">]</span>\n<span class=\"n\">DEFAULT_PY_VERSION</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;python3.9&quot;</span>\n<span class=\"n\">LOG_GROUP_PREFIX</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;/aws/lambda/&quot;</span>\n\n\n<div class=\"viewcode-block\" id=\"aws_lambda_fn\"><a class=\"viewcode-back\" href=\"../../../../../api/python/function/#runhouse.aws_lambda_fn\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">aws_lambda_fn</span><span class=\"p\">(</span>\n    <span class=\"n\">fn</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">Callable</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">paths_to_code</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">handler_function_name</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">runtime</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">args_names</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">name</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">env</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">dict</span> <span class=\"ow\">or</span> <span class=\"nb\">list</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"ow\">or</span> <span class=\"n\">Env</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">timeout</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">memory_size</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">tmp_size</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">retention_time</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">dryrun</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">False</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;Builds an instance of :class:`LambdaFunction`.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        fn (Optional[Callable]): The Lambda function to be executed.</span>\n<span class=\"sd\">        paths_to_code: (Optional[list[str]]): List of the FULL paths to the python code file(s) that should be sent to</span>\n<span class=\"sd\">            AWS Lambda. First path in the list should be the path to the handler file which contains the main</span>\n<span class=\"sd\">            (handler) function. If ``fn`` is provided, this argument is ignored.</span>\n<span class=\"sd\">        handler_function_name: (Optional[str]): The name of the function in the handler file that will be executed</span>\n<span class=\"sd\">            by the Lambda. If ``fn`` is provided, this argument is ignored.</span>\n<span class=\"sd\">        runtime: (Optional[str]): The coding language of the function. Should be one of the following:</span>\n<span class=\"sd\">            python3.7, python3.8, python3.9, python3.10, python3.11. (Default: ``python3.9``)</span>\n<span class=\"sd\">        args_names: (Optional[list[str]]): List of the function&#39;s accepted parameters, which will be passed to the</span>\n<span class=\"sd\">            Lambda Function. If your function doesn&#39;t accept arguments, please provide an empty list.</span>\n<span class=\"sd\">            If ``fn`` is provided, this argument is ignored.</span>\n<span class=\"sd\">        name (Optional[str]): Name of the Lambda Function to create or retrieve.</span>\n<span class=\"sd\">            This can be either from a local config or from the RNS.</span>\n<span class=\"sd\">        env (Optional[Dict or List[str] or Env]): Specifies the requirements that will be installed, and the environment</span>\n<span class=\"sd\">            vars that should be attached to the Lambda. Accepts three possible types:\\n</span>\n<span class=\"sd\">            1. A dict which should contain the following keys:\\n</span>\n<span class=\"sd\">               a. reqs: a list of the python libraries, to be installed by the Lambda, or just a ``requirements.txt``</span>\n<span class=\"sd\">                  string.\\n</span>\n<span class=\"sd\">               b. env_vars: dictionary containing the env_vars that will be a part of the lambda configuration.\\n</span>\n<span class=\"sd\">            2. A list of strings, containing all the required python packeages.\\n</span>\n<span class=\"sd\">            3. An instance of Runhouse Env class.\\n</span>\n<span class=\"sd\">            By default, ``runhouse`` package will be installed, and env_vars will include ``{HOME: /tmp/home}``.</span>\n<span class=\"sd\">        timeout: Optional[int]: The maximum amount of time (in secods) during which the Lambda will run in AWS</span>\n<span class=\"sd\">            without timing-out. (Default: ``900``, Min: ``3``, Max: ``900``)</span>\n<span class=\"sd\">        memory_size: Optional[int], The amount of memeory (in MB) to be allocated to the Lambda.</span>\n<span class=\"sd\">             (Default: ``1024``, Min: ``128``, Max: ``10240``)</span>\n<span class=\"sd\">        tmp_size: Optional[int], This size of the /tmp folder in the aws lambda file system.</span>\n<span class=\"sd\">             (Default: ``3072``, Min: ``512``, Max: ``10240``).</span>\n<span class=\"sd\">        retention_time: Optional[int] The time (in days) the Lambda execution logs will be saved in AWS</span>\n<span class=\"sd\">            cloudwatch. After that, they will be deleted. (Default: ``30`` days)</span>\n<span class=\"sd\">        dryrun (bool): Whether to create the Function if it doesn&#39;t exist, or load the Function object as a dryrun.</span>\n<span class=\"sd\">            (Default: ``False``).</span>\n\n<span class=\"sd\">    Returns:</span>\n<span class=\"sd\">        LambdaFunction: The resulting AWS Lambda Function object.</span>\n\n<span class=\"sd\">        .. note::</span>\n<span class=\"sd\">            When creating a Lambda function for the first time (not reloading it), the following arguments are</span>\n<span class=\"sd\">            mandatory: ``paths_to_code`` and ``handler_function_name`` OR a callable function.</span>\n\n<span class=\"sd\">    Examples:</span>\n<span class=\"sd\">        &gt;&gt;&gt; import runhouse as rh</span>\n\n<span class=\"sd\">        &gt;&gt;&gt; # handler_file.py</span>\n<span class=\"sd\">        &gt;&gt;&gt; def summer(a, b):</span>\n<span class=\"sd\">        &gt;&gt;&gt;    return a + b</span>\n\n<span class=\"sd\">        &gt;&gt;&gt; # your &#39;main&#39; python file, where you are using runhouse</span>\n<span class=\"sd\">        &gt;&gt;&gt; summer_lambda = rh.aws_lambda_fn(</span>\n<span class=\"sd\">        &gt;&gt;&gt;                     paths_to_code=[&#39;/full/path/to/handler_file.py&#39;],</span>\n<span class=\"sd\">        &gt;&gt;&gt;                     handler_function_name = &#39;summer&#39;,</span>\n<span class=\"sd\">        &gt;&gt;&gt;                     runtime = &#39;python3.9&#39;,</span>\n<span class=\"sd\">        &gt;&gt;&gt;                     name=&quot;my_func&quot;).save()</span>\n\n<span class=\"sd\">        &gt;&gt;&gt; # invoking the function</span>\n<span class=\"sd\">        &gt;&gt;&gt; summer_res = summer_lambda(5, 8)  # returns &quot;13&quot;. (It returns str type because of AWS API)</span>\n\n<span class=\"sd\">        &gt;&gt;&gt; # Load function from above</span>\n<span class=\"sd\">        &gt;&gt;&gt; reloaded_function = rh.aws_lambda_fn(name=&quot;my_func&quot;)</span>\n<span class=\"sd\">        &gt;&gt;&gt; reloaded_function_res = reloaded_function(3, 4)  # returns &quot;7&quot;.</span>\n\n<span class=\"sd\">        &gt;&gt;&gt; # Pass in a callable function  when creating a Lambda</span>\n<span class=\"sd\">        &gt;&gt;&gt; def multiply(a, b):</span>\n<span class=\"sd\">        &gt;&gt;&gt;     return a * b</span>\n<span class=\"sd\">        &gt;&gt;&gt; multiply_lambda = rh.aws_lambda_fn(fn=multiply, name=&quot;lambdas_mult_func&quot;)</span>\n<span class=\"sd\">        &gt;&gt;&gt; mult_res = multiply_lambda(4, 5)  # returns &quot;20&quot;.</span>\n\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"c1\"># TODO: [SB] in the next phase, maybe add the option to create func from git.</span>\n    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">any</span><span class=\"p\">(</span>\n        <span class=\"p\">[</span><span class=\"n\">paths_to_code</span><span class=\"p\">,</span> <span class=\"n\">handler_function_name</span><span class=\"p\">,</span> <span class=\"n\">runtime</span><span class=\"p\">,</span> <span class=\"n\">fn</span><span class=\"p\">,</span> <span class=\"n\">args_names</span><span class=\"p\">]</span>\n    <span class=\"p\">):</span>\n        <span class=\"c1\"># Try reloading existing function</span>\n        <span class=\"k\">return</span> <span class=\"n\">LambdaFunction</span><span class=\"o\">.</span><span class=\"n\">from_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span><span class=\"n\">fn</span> <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">handler_function_name</span> <span class=\"ow\">and</span> <span class=\"n\">paths_to_code</span><span class=\"p\">)):</span>\n        <span class=\"k\">raise</span> <span class=\"ne\">RuntimeError</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;Please provide a callable function OR path to handler function and its name &quot;</span>\n            <span class=\"o\">+</span> <span class=\"s2\">&quot;in order to create a Lambda function.&quot;</span>\n        <span class=\"p\">)</span>\n    <span class=\"c1\"># Env setup.</span>\n    <span class=\"k\">if</span> <span class=\"n\">env</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">,</span> <span class=\"n\">Env</span><span class=\"p\">):</span>\n        <span class=\"n\">original_env</span> <span class=\"o\">=</span> <span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">deepcopy</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">original_env</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"s2\">&quot;env_vars&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">original_env</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">():</span>\n            <span class=\"n\">env</span> <span class=\"o\">=</span> <span class=\"n\">_get_env_from</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">[</span><span class=\"s2\">&quot;reqs&quot;</span><span class=\"p\">])</span> <span class=\"ow\">or</span> <span class=\"n\">Env</span><span class=\"p\">(</span>\n                <span class=\"n\">working_dir</span><span class=\"o\">=</span><span class=\"s2\">&quot;../&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">Env</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_NAME</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">original_env</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">):</span>\n            <span class=\"n\">env</span> <span class=\"o\">=</span> <span class=\"n\">_get_env_from</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">env</span> <span class=\"o\">=</span> <span class=\"n\">_get_env_from</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"n\">Env</span><span class=\"p\">(</span><span class=\"n\">working_dir</span><span class=\"o\">=</span><span class=\"s2\">&quot;../&quot;</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">Env</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_NAME</span><span class=\"p\">)</span>\n\n    <span class=\"k\">elif</span> <span class=\"n\">env</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">env</span> <span class=\"o\">=</span> <span class=\"n\">Env</span><span class=\"p\">(</span>\n            <span class=\"n\">reqs</span><span class=\"o\">=</span><span class=\"p\">[],</span>\n            <span class=\"n\">env_vars</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;HOME&quot;</span><span class=\"p\">:</span> <span class=\"n\">LambdaFunction</span><span class=\"o\">.</span><span class=\"n\">HOME_DIR</span><span class=\"p\">},</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">Env</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_NAME</span><span class=\"p\">,</span>\n            <span class=\"n\">working_dir</span><span class=\"o\">=</span><span class=\"s2\">&quot;../&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">,</span> <span class=\"n\">Env</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"s2\">&quot;HOME&quot;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">env</span><span class=\"o\">.</span><span class=\"n\">env_vars</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">():</span>\n        <span class=\"n\">env</span><span class=\"o\">.</span><span class=\"n\">env_vars</span><span class=\"p\">[</span><span class=\"s2\">&quot;HOME&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">LambdaFunction</span><span class=\"o\">.</span><span class=\"n\">HOME_DIR</span>\n    <span class=\"c1\"># extract function pointers, path to code and arg names from callable function.</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">fn</span><span class=\"p\">,</span> <span class=\"n\">Callable</span><span class=\"p\">):</span>\n        <span class=\"n\">handler_function_name</span> <span class=\"o\">=</span> <span class=\"n\">fn</span><span class=\"o\">.</span><span class=\"vm\">__name__</span>\n        <span class=\"n\">fn_pointers</span> <span class=\"o\">=</span> <span class=\"n\">Function</span><span class=\"o\">.</span><span class=\"n\">_extract_pointers</span><span class=\"p\">(</span>\n            <span class=\"n\">fn</span><span class=\"p\">,</span> <span class=\"n\">reqs</span><span class=\"o\">=</span><span class=\"p\">[]</span> <span class=\"k\">if</span> <span class=\"n\">env</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"n\">env</span><span class=\"o\">.</span><span class=\"n\">reqs</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">paths_to_code</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">Function</span><span class=\"o\">.</span><span class=\"n\">_extract_module_path</span><span class=\"p\">(</span><span class=\"n\">fn</span><span class=\"p\">)]</span>\n        <span class=\"n\">args_names</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">param</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">param</span> <span class=\"ow\">in</span> <span class=\"n\">inspect</span><span class=\"o\">.</span><span class=\"n\">signature</span><span class=\"p\">(</span><span class=\"n\">fn</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">parameters</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">()]</span>\n        <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">fn</span><span class=\"o\">.</span><span class=\"vm\">__name__</span>\n\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n\n        <span class=\"c1\"># ------- arguments validation -------</span>\n        <span class=\"k\">if</span> <span class=\"n\">paths_to_code</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">paths_to_code</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">RuntimeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Please provide a path to the lambda handler file.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"s2\">&quot;requirements.txt&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">env</span><span class=\"p\">:</span>\n            <span class=\"n\">paths_to_code</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">Path</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">absolute</span><span class=\"p\">())</span>\n        <span class=\"k\">if</span> <span class=\"n\">handler_function_name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">handler_function_name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">RuntimeError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Please provide the name of the function that should be executed by the lambda.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">args_names</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"c1\"># extracting the arguments names of the handler function.</span>\n            <span class=\"n\">file_path</span> <span class=\"o\">=</span> <span class=\"n\">paths_to_code</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n            <span class=\"n\">func_name</span> <span class=\"o\">=</span> <span class=\"n\">handler_function_name</span>\n            <span class=\"n\">spec</span> <span class=\"o\">=</span> <span class=\"n\">importlib</span><span class=\"o\">.</span><span class=\"n\">util</span><span class=\"o\">.</span><span class=\"n\">spec_from_file_location</span><span class=\"p\">(</span><span class=\"n\">file_path</span><span class=\"p\">,</span> <span class=\"n\">file_path</span><span class=\"p\">)</span>\n            <span class=\"n\">module</span> <span class=\"o\">=</span> <span class=\"n\">importlib</span><span class=\"o\">.</span><span class=\"n\">util</span><span class=\"o\">.</span><span class=\"n\">module_from_spec</span><span class=\"p\">(</span><span class=\"n\">spec</span><span class=\"p\">)</span>\n            <span class=\"n\">spec</span><span class=\"o\">.</span><span class=\"n\">loader</span><span class=\"o\">.</span><span class=\"n\">exec_module</span><span class=\"p\">(</span><span class=\"n\">module</span><span class=\"p\">)</span>\n            <span class=\"c1\"># Extract the function and its arguments</span>\n            <span class=\"n\">func</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">module</span><span class=\"p\">,</span> <span class=\"n\">func_name</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n            <span class=\"n\">args_names</span> <span class=\"o\">=</span> <span class=\"n\">inspect</span><span class=\"o\">.</span><span class=\"n\">getfullargspec</span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">args</span>\n            <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;Arguments names were not provided. Extracted the following args names: </span><span class=\"si\">{</span><span class=\"n\">args_names</span><span class=\"si\">}</span><span class=\"s2\">.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">handler_function_name</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s2\">&quot;.&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">fn_pointers</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"c1\"># ------- More arguments validation -------</span>\n    <span class=\"k\">if</span> <span class=\"n\">runtime</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"n\">runtime</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">SUPPORTED_RUNTIMES</span><span class=\"p\">:</span>\n        <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n            <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">runtime</span><span class=\"si\">}</span><span class=\"s2\"> is not a supported by AWS Lambda. Setting runtime to python3.9.&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">runtime</span> <span class=\"o\">=</span> <span class=\"n\">DEFAULT_PY_VERSION</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">timeout</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Timeout set to 15 min.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">timeout</span> <span class=\"o\">=</span> <span class=\"n\">LambdaFunction</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_TIMEOUT</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">env</span><span class=\"o\">.</span><span class=\"n\">reqs</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"o\">.</span><span class=\"n\">reqs</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">timeout</span> <span class=\"o\">&lt;</span> <span class=\"mi\">600</span><span class=\"p\">:</span>\n            <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Increasing the timeout to 600 sec, in order to enable the packages setup.&quot;</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">timeout</span> <span class=\"o\">=</span> <span class=\"mi\">600</span>\n        <span class=\"k\">if</span> <span class=\"n\">timeout</span> <span class=\"o\">&gt;</span> <span class=\"mi\">900</span><span class=\"p\">:</span>\n            <span class=\"n\">timeout</span> <span class=\"o\">=</span> <span class=\"mi\">900</span>\n            <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Timeout can not be more then 900 sec, setting to 900 sec.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">timeout</span> <span class=\"o\">&lt;</span> <span class=\"mi\">3</span><span class=\"p\">:</span>\n            <span class=\"n\">timeout</span> <span class=\"o\">=</span> <span class=\"mi\">3</span>\n            <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Timeout can not be less then 3 sec, setting to 3 sec.&quot;</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">memory_size</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Memory size set to 1024 MB.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">memory_size</span> <span class=\"o\">=</span> <span class=\"n\">LambdaFunction</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_MEMORY_SIZE</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">env</span><span class=\"o\">.</span><span class=\"n\">reqs</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"o\">.</span><span class=\"n\">reqs</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span>\n        <span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">memory_size</span> <span class=\"o\">&lt;</span> <span class=\"n\">LambdaFunction</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_MEMORY_SIZE</span><span class=\"p\">:</span>\n            <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Increasing the memory size to 1G, in order to enable the packages setup.&quot;</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">memory_size</span> <span class=\"o\">=</span> <span class=\"n\">LambdaFunction</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_MEMORY_SIZE</span>\n        <span class=\"k\">if</span> <span class=\"n\">memory_size</span> <span class=\"o\">&lt;</span> <span class=\"mi\">128</span><span class=\"p\">:</span>\n            <span class=\"n\">memory_size</span> <span class=\"o\">=</span> <span class=\"mi\">128</span>\n            <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Memory size can not be less then 128 MB, setting to 128 MB.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">memory_size</span> <span class=\"o\">&gt;</span> <span class=\"mi\">10240</span><span class=\"p\">:</span>\n            <span class=\"n\">memory_size</span> <span class=\"o\">=</span> <span class=\"mi\">10240</span>\n            <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Memory size can not be more then 10240 MB, setting to 10240 MB.&quot;</span>\n            <span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">tmp_size</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"n\">tmp_size</span> <span class=\"o\">&lt;</span> <span class=\"n\">LambdaFunction</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_TMP_SIZE</span><span class=\"p\">:</span>\n        <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;Setting /tmp size to 3GB, in order to enable the packages setup.&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">tmp_size</span> <span class=\"o\">=</span> <span class=\"n\">LambdaFunction</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_TMP_SIZE</span>\n    <span class=\"k\">elif</span> <span class=\"n\">tmp_size</span> <span class=\"o\">&gt;</span> <span class=\"mi\">10240</span><span class=\"p\">:</span>\n        <span class=\"n\">tmp_size</span> <span class=\"o\">=</span> <span class=\"mi\">10240</span>\n        <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;/tmp size can not be more then 10240 MB, setting to 10240 MB.&quot;</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">retention_time</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">retention_time</span> <span class=\"o\">=</span> <span class=\"n\">LambdaFunction</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_RETENTION</span>\n\n    <span class=\"n\">new_function</span> <span class=\"o\">=</span> <span class=\"n\">LambdaFunction</span><span class=\"p\">(</span>\n        <span class=\"n\">fn_pointers</span><span class=\"o\">=</span><span class=\"n\">fn_pointers</span><span class=\"p\">,</span>\n        <span class=\"n\">paths_to_code</span><span class=\"o\">=</span><span class=\"n\">paths_to_code</span><span class=\"p\">,</span>\n        <span class=\"n\">handler_function_name</span><span class=\"o\">=</span><span class=\"n\">handler_function_name</span><span class=\"p\">,</span>\n        <span class=\"n\">runtime</span><span class=\"o\">=</span><span class=\"n\">runtime</span><span class=\"p\">,</span>\n        <span class=\"n\">args_names</span><span class=\"o\">=</span><span class=\"n\">args_names</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">,</span>\n        <span class=\"n\">env</span><span class=\"o\">=</span><span class=\"n\">env</span><span class=\"p\">,</span>\n        <span class=\"n\">dryrun</span><span class=\"o\">=</span><span class=\"n\">dryrun</span><span class=\"p\">,</span>\n        <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"n\">timeout</span><span class=\"p\">,</span>\n        <span class=\"n\">memory_size</span><span class=\"o\">=</span><span class=\"n\">memory_size</span><span class=\"p\">,</span>\n        <span class=\"n\">tmp_size</span><span class=\"o\">=</span><span class=\"n\">tmp_size</span><span class=\"p\">,</span>\n        <span class=\"n\">retention_time</span><span class=\"o\">=</span><span class=\"n\">retention_time</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">dryrun</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">new_function</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">new_function</span><span class=\"o\">.</span><span class=\"n\">deploy</span><span class=\"p\">()</span></div>\n</pre></div>", "current_page_name": "_modules/runhouse/resources/functions/aws_lambda_factory", "sidebars": ["about.html", "navigation.html", "relations.html", "searchbox.html", "donate.html"], "customsidebar": null, "alabaster_version": "0.7.13"}