{"parents": [{"link": "../../../../", "title": "Module code"}], "title": "runhouse.resources.functionals.mapper", "body": "<h1>Source code for runhouse.resources.functionals.mapper</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">concurrent.futures</span>\n<span class=\"kn\">import</span> <span class=\"nn\">contextvars</span>\n<span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">from</span> <span class=\"nn\">typing</span> <span class=\"kn\">import</span> <span class=\"n\">Callable</span><span class=\"p\">,</span> <span class=\"n\">List</span><span class=\"p\">,</span> <span class=\"n\">Optional</span><span class=\"p\">,</span> <span class=\"n\">Union</span>\n\n<span class=\"k\">try</span><span class=\"p\">:</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">tqdm</span> <span class=\"kn\">import</span> <span class=\"n\">tqdm</span>\n<span class=\"k\">except</span> <span class=\"ne\">ImportError</span><span class=\"p\">:</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">tqdm</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">args</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n\n<span class=\"kn\">from</span> <span class=\"nn\">runhouse.resources.functions</span> <span class=\"kn\">import</span> <span class=\"n\">function</span><span class=\"p\">,</span> <span class=\"n\">Function</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">runhouse.resources.module</span> <span class=\"kn\">import</span> <span class=\"n\">Module</span>\n\n<span class=\"n\">logger</span> <span class=\"o\">=</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">getLogger</span><span class=\"p\">(</span><span class=\"vm\">__name__</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"Mapper\"><a class=\"viewcode-back\" href=\"../../../../../api/python/mapper/#runhouse.Mapper\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Mapper</span><span class=\"p\">(</span><span class=\"n\">Module</span><span class=\"p\">):</span>\n<div class=\"viewcode-block\" id=\"Mapper.__init__\"><a class=\"viewcode-back\" href=\"../../../../../api/python/mapper/#runhouse.Mapper.__init__\">[docs]</a>    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">module</span><span class=\"p\">:</span> <span class=\"n\">Module</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">method</span><span class=\"p\">:</span> <span class=\"nb\">str</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">replicas</span><span class=\"p\">:</span> <span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"n\">Module</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">concurrency</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n        <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n<span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Runhouse Mapper object. It is used for mapping a function or module method over a list of inputs,</span>\n<span class=\"sd\">        across a series of replicas.</span>\n\n<span class=\"sd\">        .. note::</span>\n<span class=\"sd\">                To create a Mapper, please use the factory method :func:`mapper`.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module</span> <span class=\"o\">=</span> <span class=\"n\">module</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">method</span> <span class=\"o\">=</span> <span class=\"n\">method</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">concurrency</span> <span class=\"o\">=</span> <span class=\"n\">concurrency</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_num_auto_replicas</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_auto_replicas</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_user_replicas</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_last_called</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">replicas</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module</span><span class=\"o\">.</span><span class=\"n\">system</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Only add replicas if the replicated module is already on a cluster</span>\n                <span class=\"k\">if</span> <span class=\"n\">replicas</span> <span class=\"o\">&gt;</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">num_replicas</span> <span class=\"ow\">and</span> <span class=\"n\">replicas</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">add_replicas</span><span class=\"p\">(</span><span class=\"n\">replicas</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Otherwise, store this for later once we&#39;ve sent the mapper to the cluster</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_num_auto_replicas</span> <span class=\"o\">=</span> <span class=\"n\">replicas</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">replicas</span><span class=\"p\">,</span> <span class=\"nb\">list</span><span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_user_replicas</span> <span class=\"o\">=</span> <span class=\"n\">replicas</span></div>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">replicas</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_auto_replicas</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_user_replicas</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">num_replicas</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">replicas</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_replicas</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">replicas</span><span class=\"p\">:</span> <span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"n\">Module</span><span class=\"p\">]]):</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">replicas</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">):</span>\n            <span class=\"n\">new_replicas</span> <span class=\"o\">=</span> <span class=\"n\">replicas</span> <span class=\"o\">-</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">num_replicas</span>\n            <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;Adding </span><span class=\"si\">{</span><span class=\"n\">new_replicas</span><span class=\"si\">}</span><span class=\"s2\"> replicas&quot;</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_add_auto_replicas</span><span class=\"p\">(</span><span class=\"n\">new_replicas</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_user_replicas</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">replicas</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">drop_replicas</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">num_replicas</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">reap</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">reap</span><span class=\"p\">:</span>\n            <span class=\"k\">for</span> <span class=\"n\">replica</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_auto_replicas</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"n\">num_replicas</span><span class=\"p\">:]:</span>\n                <span class=\"n\">replica</span><span class=\"o\">.</span><span class=\"n\">system</span><span class=\"o\">.</span><span class=\"n\">kill</span><span class=\"p\">(</span><span class=\"n\">replica</span><span class=\"o\">.</span><span class=\"n\">env</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_auto_replicas</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_auto_replicas</span><span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"n\">num_replicas</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_add_auto_replicas</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">num_replicas</span><span class=\"p\">:</span> <span class=\"nb\">int</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_auto_replicas</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module</span><span class=\"o\">.</span><span class=\"n\">replicate</span><span class=\"p\">(</span><span class=\"n\">num_replicas</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">increment_counter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_last_called</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_last_called</span> <span class=\"o\">&gt;=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">replicas</span><span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_last_called</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_last_called</span>\n\n<div class=\"viewcode-block\" id=\"Mapper.to\"><a class=\"viewcode-back\" href=\"../../../../../api/python/mapper/#runhouse.Mapper.to\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">to</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module</span><span class=\"o\">.</span><span class=\"n\">system</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module</span><span class=\"o\">.</span><span class=\"n\">to</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"n\">remote_mapper</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">to</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_num_auto_replicas</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">):</span>\n            <span class=\"n\">remote_mapper</span><span class=\"o\">.</span><span class=\"n\">add_replicas</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_num_auto_replicas</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">remote_mapper</span></div>\n\n<div class=\"viewcode-block\" id=\"Mapper.map\"><a class=\"viewcode-back\" href=\"../../../../../api/python/mapper/#runhouse.Mapper.map\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">map</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">method</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">retries</span><span class=\"p\">:</span> <span class=\"nb\">int</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n<span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Map the function or method over a list of arguments.</span>\n\n<span class=\"sd\">        Example:</span>\n<span class=\"sd\">            &gt;&gt;&gt; def local_sum(arg1, arg2, arg3):</span>\n<span class=\"sd\">            &gt;&gt;&gt;     return arg1 + arg2 + arg3</span>\n<span class=\"sd\">            &gt;&gt;&gt;</span>\n<span class=\"sd\">            &gt;&gt;&gt; remote_fn = rh.function(local_sum).to(my_cluster)</span>\n<span class=\"sd\">            &gt;&gt;&gt; mapper = rh.mapper(remote_fn, replicas=2)</span>\n<span class=\"sd\">            &gt;&gt;&gt; mapper.map([1, 2], [1, 4], [2, 3])</span>\n<span class=\"sd\">            &gt;&gt;&gt; # output: [4, 9]</span>\n\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"c1\"># Don&#39;t stream logs by default unless the mapper is remote (i.e. mediating the mapping)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">starmap</span><span class=\"p\">(</span>\n            <span class=\"n\">arg_list</span><span class=\"o\">=</span><span class=\"nb\">zip</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">),</span> <span class=\"n\">method</span><span class=\"o\">=</span><span class=\"n\">method</span><span class=\"p\">,</span> <span class=\"n\">retries</span><span class=\"o\">=</span><span class=\"n\">retries</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span>\n        <span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"Mapper.starmap\"><a class=\"viewcode-back\" href=\"../../../../../api/python/mapper/#runhouse.Mapper.starmap\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">starmap</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">arg_list</span><span class=\"p\">:</span> <span class=\"n\">List</span><span class=\"p\">,</span> <span class=\"n\">method</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">retries</span><span class=\"p\">:</span> <span class=\"nb\">int</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span>\n    <span class=\"p\">):</span>\n<span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Like :func:`map` except that the elements of the iterable are expected to be iterables</span>\n<span class=\"sd\">        that are unpacked as arguments. An iterable of ``[(1,2), (3, 4)]`` results in</span>\n<span class=\"sd\">        ``func(1,2), func(3,4)]``.</span>\n\n<span class=\"sd\">        Example:</span>\n<span class=\"sd\">            &gt;&gt;&gt; def local_sum(arg1, arg2, arg3):</span>\n<span class=\"sd\">            &gt;&gt;&gt;     return arg1 + arg2 + arg3</span>\n<span class=\"sd\">            &gt;&gt;&gt;</span>\n<span class=\"sd\">            &gt;&gt;&gt; remote_fn = rh.function(local_sum).to(my_cluster)</span>\n<span class=\"sd\">            &gt;&gt;&gt; mapper = rh.mapper(remote_fn, replicas=2)</span>\n<span class=\"sd\">            &gt;&gt;&gt; arg_list = [(1,2), (3, 4)]</span>\n<span class=\"sd\">            &gt;&gt;&gt; # runs the function twice, once with args (1, 2) and once with args (3, 4)</span>\n<span class=\"sd\">            &gt;&gt;&gt; mapper.starmap(arg_list)</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"c1\"># Don&#39;t stream logs by default unless the mapper is remote (i.e. mediating the mapping)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">system</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">system</span><span class=\"o\">.</span><span class=\"n\">on_this_cluster</span><span class=\"p\">():</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;stream_logs&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">kwargs</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;stream_logs&quot;</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;stream_logs&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">kwargs</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;stream_logs&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span>\n\n        <span class=\"n\">retry_list</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n\n        <span class=\"k\">def</span> <span class=\"nf\">call_method_on_replica</span><span class=\"p\">(</span><span class=\"n\">job</span><span class=\"p\">,</span> <span class=\"n\">retry</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n            <span class=\"n\">replica</span><span class=\"p\">,</span> <span class=\"n\">method_name</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">argies</span><span class=\"p\">,</span> <span class=\"n\">kwargies</span> <span class=\"o\">=</span> <span class=\"n\">job</span>\n            <span class=\"c1\"># reset context</span>\n            <span class=\"k\">for</span> <span class=\"n\">var</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n                <span class=\"n\">var</span><span class=\"o\">.</span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">replica</span><span class=\"p\">,</span> <span class=\"n\">method_name</span><span class=\"p\">)(</span><span class=\"o\">*</span><span class=\"n\">argies</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargies</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"ne\">Exception</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n                <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;Error running </span><span class=\"si\">{</span><span class=\"n\">method_name</span><span class=\"si\">}</span><span class=\"s2\"> on </span><span class=\"si\">{</span><span class=\"n\">replica</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s2\">: </span><span class=\"si\">{</span><span class=\"n\">e</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">retry</span><span class=\"p\">:</span>\n                    <span class=\"n\">retry_list</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">job</span><span class=\"p\">)</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"k\">return</span> <span class=\"n\">e</span>\n\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"n\">contextvars</span><span class=\"o\">.</span><span class=\"n\">copy_context</span><span class=\"p\">()</span>\n        <span class=\"n\">jobs</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">replicas</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">increment_counter</span><span class=\"p\">()],</span>\n                <span class=\"n\">method</span> <span class=\"ow\">or</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">method</span><span class=\"p\">,</span>\n                <span class=\"n\">context</span><span class=\"p\">,</span>\n                <span class=\"n\">args</span><span class=\"p\">,</span>\n                <span class=\"n\">kwargs</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">args</span> <span class=\"ow\">in</span> <span class=\"n\">arg_list</span>\n        <span class=\"p\">]</span>\n\n        <span class=\"n\">results</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"n\">max_threads</span> <span class=\"o\">=</span> <span class=\"nb\">round</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">concurrency</span> <span class=\"o\">*</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">num_replicas</span><span class=\"p\">)</span>\n        <span class=\"k\">with</span> <span class=\"n\">concurrent</span><span class=\"o\">.</span><span class=\"n\">futures</span><span class=\"o\">.</span><span class=\"n\">ThreadPoolExecutor</span><span class=\"p\">(</span><span class=\"n\">max_workers</span><span class=\"o\">=</span><span class=\"n\">max_threads</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">executor</span><span class=\"p\">:</span>\n            <span class=\"n\">futs</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n                <span class=\"n\">executor</span><span class=\"o\">.</span><span class=\"n\">submit</span><span class=\"p\">(</span><span class=\"n\">call_method_on_replica</span><span class=\"p\">,</span> <span class=\"n\">job</span><span class=\"p\">,</span> <span class=\"n\">retries</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n                <span class=\"k\">for</span> <span class=\"n\">job</span> <span class=\"ow\">in</span> <span class=\"n\">jobs</span>\n            <span class=\"p\">]</span>\n            <span class=\"k\">for</span> <span class=\"n\">fut</span> <span class=\"ow\">in</span> <span class=\"n\">tqdm</span><span class=\"p\">(</span><span class=\"n\">concurrent</span><span class=\"o\">.</span><span class=\"n\">futures</span><span class=\"o\">.</span><span class=\"n\">as_completed</span><span class=\"p\">(</span><span class=\"n\">futs</span><span class=\"p\">),</span> <span class=\"n\">total</span><span class=\"o\">=</span><span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">jobs</span><span class=\"p\">)):</span>\n                <span class=\"n\">results</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">([</span><span class=\"n\">fut</span><span class=\"o\">.</span><span class=\"n\">result</span><span class=\"p\">()])</span>\n            <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"n\">retries</span><span class=\"p\">):</span>\n                <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">retry_list</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n                    <span class=\"k\">break</span>\n                <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;Retry </span><span class=\"si\">{</span><span class=\"n\">i</span><span class=\"si\">}</span><span class=\"s2\">: </span><span class=\"si\">{</span><span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">retry_list</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s2\"> failed jobs&quot;</span><span class=\"p\">)</span>\n                <span class=\"n\">jobs</span><span class=\"p\">,</span> <span class=\"n\">retry_list</span> <span class=\"o\">=</span> <span class=\"n\">retry_list</span><span class=\"p\">,</span> <span class=\"p\">[]</span>\n                <span class=\"n\">retry</span> <span class=\"o\">=</span> <span class=\"n\">i</span> <span class=\"o\">!=</span> <span class=\"n\">retries</span> <span class=\"o\">-</span> <span class=\"mi\">1</span>\n                <span class=\"n\">results</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                    <span class=\"nb\">list</span><span class=\"p\">(</span>\n                        <span class=\"n\">tqdm</span><span class=\"p\">(</span>\n                            <span class=\"n\">executor</span><span class=\"o\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"n\">call_method_on_replica</span><span class=\"p\">,</span> <span class=\"n\">jobs</span><span class=\"p\">,</span> <span class=\"n\">retry</span><span class=\"p\">),</span>\n                            <span class=\"n\">total</span><span class=\"o\">=</span><span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">jobs</span><span class=\"p\">),</span>\n                        <span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">results</span></div>\n\n        <span class=\"c1\"># TODO should we add an async version of this for when we&#39;re on the cluster?</span>\n        <span class=\"c1\"># async def call_method_on_args(argies):</span>\n        <span class=\"c1\">#     return getattr(self.replicas[self.increment_counter()], self.method)(*argies, **kwargs)</span>\n        <span class=\"c1\">#</span>\n        <span class=\"c1\"># async def gather():</span>\n        <span class=\"c1\">#     return await asyncio.gather(</span>\n        <span class=\"c1\">#         *[</span>\n        <span class=\"c1\">#             call_method_on_args(args)</span>\n        <span class=\"c1\">#             for args in zip(*args)</span>\n        <span class=\"c1\">#         ]</span>\n        <span class=\"c1\">#     )</span>\n        <span class=\"c1\"># return asyncio.run(gather())</span>\n\n<div class=\"viewcode-block\" id=\"Mapper.call\"><a class=\"viewcode-back\" href=\"../../../../../api/python/mapper/#runhouse.Mapper.call\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">call</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">method</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n<span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Call the function or method on a single replica.</span>\n\n<span class=\"sd\">        Example:</span>\n<span class=\"sd\">            &gt;&gt;&gt; def local_sum(arg1, arg2, arg3):</span>\n<span class=\"sd\">            &gt;&gt;&gt;     return arg1 + arg2 + arg3</span>\n<span class=\"sd\">            &gt;&gt;&gt;</span>\n<span class=\"sd\">            &gt;&gt;&gt; remote_fn = rh.function(local_sum).to(my_cluster)</span>\n<span class=\"sd\">            &gt;&gt;&gt; mapper = rh.mapper(remote_fn, replicas=2)</span>\n<span class=\"sd\">            &gt;&gt;&gt; for i in range(10):</span>\n<span class=\"sd\">            &gt;&gt;&gt;     mapper.call(i, 1, 2)</span>\n<span class=\"sd\">            &gt;&gt;&gt;     # output: 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, run in round-robin replica order</span>\n\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">replicas</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">increment_counter</span><span class=\"p\">()],</span> <span class=\"n\">method</span> <span class=\"ow\">or</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">method</span><span class=\"p\">)(</span>\n            <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span>\n        <span class=\"p\">)</span></div></div>\n\n\n<div class=\"viewcode-block\" id=\"mapper\"><a class=\"viewcode-back\" href=\"../../../../../api/python/mapper/#runhouse.mapper\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">mapper</span><span class=\"p\">(</span>\n    <span class=\"n\">module</span><span class=\"p\">:</span> <span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"n\">Module</span><span class=\"p\">,</span> <span class=\"n\">Callable</span><span class=\"p\">],</span>\n    <span class=\"n\">method</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">replicas</span><span class=\"p\">:</span> <span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"n\">Module</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">concurrency</span><span class=\"p\">:</span> <span class=\"nb\">int</span> <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">,</span>\n    <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n<span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">Mapper</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    A factory method for creating Mapper modules. A mapper is a module that can map a function or module method over</span>\n<span class=\"sd\">    a list of inputs in various ways.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        module (Module): The module or function to be mapped.</span>\n<span class=\"sd\">        method (Optional[str], optional): The method of the module to be called. If the module is already a callable,</span>\n<span class=\"sd\">            this value defaults to ``&quot;call&quot;``.</span>\n<span class=\"sd\">        concurrency (int, optional): The number of concurrent calls to each replica, executed in separate threads.</span>\n<span class=\"sd\">            Defaults to 1.</span>\n<span class=\"sd\">        replicas (Optional[List[Module]], optional): List of user-specified replicas, or an int specifying the number</span>\n<span class=\"sd\">            of replicas to be automatically created. Defaults to None.</span>\n\n<span class=\"sd\">    Returns:</span>\n<span class=\"sd\">        Mapper: The resulting Mapper object.</span>\n\n<span class=\"sd\">    Example:</span>\n<span class=\"sd\">        &gt;&gt;&gt; remote_fn = rh.function(local_fn).to(cluster)</span>\n<span class=\"sd\">        &gt;&gt;&gt; mapper = rh.mapper(remote_fn, replicas=2)</span>\n\n<span class=\"sd\">        &gt;&gt;&gt; remote_module = rh.module(cls=MyClass).to(system=cluster, env=&quot;my_env&quot;)</span>\n<span class=\"sd\">        &gt;&gt;&gt; mapper = rh.mapper(remote_module, method=my_class_method, replicas=-1)</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">if</span> <span class=\"nb\">callable</span><span class=\"p\">(</span><span class=\"n\">module</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">module</span><span class=\"p\">,</span> <span class=\"n\">Module</span><span class=\"p\">):</span>\n        <span class=\"n\">module</span> <span class=\"o\">=</span> <span class=\"n\">function</span><span class=\"p\">(</span><span class=\"n\">module</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">module</span><span class=\"p\">,</span> <span class=\"n\">Function</span><span class=\"p\">):</span>\n        <span class=\"n\">method</span> <span class=\"o\">=</span> <span class=\"n\">method</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;call&quot;</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">Mapper</span><span class=\"p\">(</span>\n        <span class=\"n\">module</span><span class=\"o\">=</span><span class=\"n\">module</span><span class=\"p\">,</span>\n        <span class=\"n\">method</span><span class=\"o\">=</span><span class=\"n\">method</span><span class=\"p\">,</span>\n        <span class=\"n\">replicas</span><span class=\"o\">=</span><span class=\"n\">replicas</span><span class=\"p\">,</span>\n        <span class=\"n\">concurrency</span><span class=\"o\">=</span><span class=\"n\">concurrency</span><span class=\"p\">,</span>\n        <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/runhouse/resources/functionals/mapper", "sidebars": ["about.html", "navigation.html", "relations.html", "searchbox.html", "donate.html"], "customsidebar": null, "alabaster_version": "0.7.16", "alabaster_version_info": [0, 7, 16]}