{"parents": [{"link": "../../../../", "title": "Module code"}], "title": "runhouse.resources.envs.env_factory", "body": "<h1>Source code for runhouse.resources.envs.env_factory</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">datetime</span> <span class=\"kn\">import</span> <span class=\"n\">datetime</span>\n<span class=\"kn\">from</span> <span class=\"nn\">pathlib</span> <span class=\"kn\">import</span> <span class=\"n\">Path</span>\n<span class=\"kn\">from</span> <span class=\"nn\">typing</span> <span class=\"kn\">import</span> <span class=\"n\">Dict</span><span class=\"p\">,</span> <span class=\"n\">List</span><span class=\"p\">,</span> <span class=\"n\">Optional</span><span class=\"p\">,</span> <span class=\"n\">Union</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">runhouse.resources.packages</span> <span class=\"kn\">import</span> <span class=\"n\">Package</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.conda_env</span> <span class=\"kn\">import</span> <span class=\"n\">CondaEnv</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.env</span> <span class=\"kn\">import</span> <span class=\"n\">Env</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.utils</span> <span class=\"kn\">import</span> <span class=\"n\">_get_conda_yaml</span><span class=\"p\">,</span> <span class=\"n\">_process_reqs</span>\n\n\n<span class=\"c1\"># generic Env factory method</span>\n<div class=\"viewcode-block\" id=\"env\"><a class=\"viewcode-back\" href=\"../../../../../api/python/env/#runhouse.env\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">env</span><span class=\"p\">(</span>\n    <span class=\"n\">reqs</span><span class=\"p\">:</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">Package</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"p\">[],</span>\n    <span class=\"n\">conda_env</span><span class=\"p\">:</span> <span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">Dict</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">name</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">setup_cmds</span><span class=\"p\">:</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">env_vars</span><span class=\"p\">:</span> <span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"n\">Dict</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">{},</span>\n    <span class=\"n\">working_dir</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">Path</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;./&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">secrets</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Secret&quot;</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"p\">[],</span>\n    <span class=\"n\">dryrun</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">False</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;Builds an instance of :class:`Env`.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        reqs (List[str]): List of package names to install in this environment.</span>\n<span class=\"sd\">        conda_env (Union[str, Dict], optional): Dict representing conda env, Path to a conda env yaml file,</span>\n<span class=\"sd\">            or name of a local conda environment.</span>\n<span class=\"sd\">        name (Optional[str], optional): Name of the environment resource.</span>\n<span class=\"sd\">        setup_cmds (Optional[List[str]]): List of CLI commands to run for setup when the environment is</span>\n<span class=\"sd\">            being set up on a cluster.</span>\n<span class=\"sd\">        env_vars (Dict or str): Dictionary of environment variables, or relative path to .env file containing</span>\n<span class=\"sd\">            environment variables. (Default: {})</span>\n<span class=\"sd\">        working_dir (str or Path): Working directory of the environment, to be loaded onto the system.</span>\n<span class=\"sd\">            (Default: &quot;./&quot;)</span>\n<span class=\"sd\">        dryrun (bool, optional): Whether to run in dryrun mode. (Default: ``False``)</span>\n\n\n<span class=\"sd\">    Returns:</span>\n<span class=\"sd\">        Env: The resulting Env object.</span>\n\n<span class=\"sd\">    Example:</span>\n<span class=\"sd\">        &gt;&gt;&gt; # regular python env</span>\n<span class=\"sd\">        &gt;&gt;&gt; env = rh.env(reqs=[&quot;torch&quot;, &quot;pip&quot;])</span>\n<span class=\"sd\">        &gt;&gt;&gt; env = rh.env(reqs=[&quot;reqs:./&quot;], name=&quot;myenv&quot;)</span>\n<span class=\"sd\">        &gt;&gt;&gt;</span>\n<span class=\"sd\">        &gt;&gt;&gt; # conda env, see also rh.conda_env</span>\n<span class=\"sd\">        &gt;&gt;&gt; conda_env_dict =</span>\n<span class=\"sd\">        &gt;&gt;&gt;     {&quot;name&quot;: &quot;new-conda-env&quot;, &quot;channels&quot;: [&quot;defaults&quot;], &quot;dependencies&quot;: &quot;pip&quot;, {&quot;pip&quot;: &quot;diffusers&quot;})</span>\n<span class=\"sd\">        &gt;&gt;&gt; conda_env = rh.env(conda_env=conda_env_dict)             # from a dict</span>\n<span class=\"sd\">        &gt;&gt;&gt; conda_env = rh.env(conda_env=&quot;conda_env.yaml&quot;)           # from a yaml file</span>\n<span class=\"sd\">        &gt;&gt;&gt; conda_env = rh.env(conda_env=&quot;local-conda-env-name&quot;)     # from a existing local conda env</span>\n<span class=\"sd\">        &gt;&gt;&gt; conda_env = rh.env(conda_env=&quot;conda_env.yaml&quot;, reqs=[&quot;pip:/accelerate&quot;])   # with additional reqs</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">any</span><span class=\"p\">([</span><span class=\"n\">reqs</span><span class=\"p\">,</span> <span class=\"n\">conda_env</span><span class=\"p\">,</span> <span class=\"n\">setup_cmds</span><span class=\"p\">,</span> <span class=\"n\">env_vars</span><span class=\"p\">,</span> <span class=\"n\">secrets</span><span class=\"p\">]):</span>\n        <span class=\"k\">return</span> <span class=\"n\">Env</span><span class=\"o\">.</span><span class=\"n\">from_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">dryrun</span><span class=\"p\">)</span>\n\n    <span class=\"n\">reqs</span> <span class=\"o\">=</span> <span class=\"n\">_process_reqs</span><span class=\"p\">(</span><span class=\"n\">reqs</span> <span class=\"ow\">or</span> <span class=\"p\">[])</span>\n    <span class=\"n\">conda_yaml</span> <span class=\"o\">=</span> <span class=\"n\">_get_conda_yaml</span><span class=\"p\">(</span><span class=\"n\">conda_env</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">conda_yaml</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">CondaEnv</span><span class=\"p\">(</span>\n            <span class=\"n\">conda_yaml</span><span class=\"o\">=</span><span class=\"n\">conda_yaml</span><span class=\"p\">,</span>\n            <span class=\"n\">reqs</span><span class=\"o\">=</span><span class=\"n\">reqs</span><span class=\"p\">,</span>\n            <span class=\"n\">setup_cmds</span><span class=\"o\">=</span><span class=\"n\">setup_cmds</span><span class=\"p\">,</span>\n            <span class=\"n\">env_vars</span><span class=\"o\">=</span><span class=\"n\">env_vars</span><span class=\"p\">,</span>\n            <span class=\"n\">working_dir</span><span class=\"o\">=</span><span class=\"n\">working_dir</span><span class=\"p\">,</span>\n            <span class=\"n\">secrets</span><span class=\"o\">=</span><span class=\"n\">secrets</span><span class=\"p\">,</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span> <span class=\"ow\">or</span> <span class=\"n\">conda_yaml</span><span class=\"p\">[</span><span class=\"s2\">&quot;name&quot;</span><span class=\"p\">],</span>\n            <span class=\"n\">dryrun</span><span class=\"o\">=</span><span class=\"n\">dryrun</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">Env</span><span class=\"p\">(</span>\n        <span class=\"n\">reqs</span><span class=\"o\">=</span><span class=\"n\">reqs</span><span class=\"p\">,</span>\n        <span class=\"n\">setup_cmds</span><span class=\"o\">=</span><span class=\"n\">setup_cmds</span><span class=\"p\">,</span>\n        <span class=\"n\">env_vars</span><span class=\"o\">=</span><span class=\"n\">env_vars</span><span class=\"p\">,</span>\n        <span class=\"n\">working_dir</span><span class=\"o\">=</span><span class=\"n\">working_dir</span><span class=\"p\">,</span>\n        <span class=\"n\">secrets</span><span class=\"o\">=</span><span class=\"n\">secrets</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span> <span class=\"ow\">or</span> <span class=\"n\">Env</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_NAME</span><span class=\"p\">,</span>\n        <span class=\"n\">dryrun</span><span class=\"o\">=</span><span class=\"n\">dryrun</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span></div>\n\n\n<span class=\"c1\"># Conda Env factory method</span>\n<div class=\"viewcode-block\" id=\"conda_env\"><a class=\"viewcode-back\" href=\"../../../../../api/python/env/#runhouse.conda_env\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">conda_env</span><span class=\"p\">(</span>\n    <span class=\"n\">reqs</span><span class=\"p\">:</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">Package</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"p\">[],</span>\n    <span class=\"n\">conda_env</span><span class=\"p\">:</span> <span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">Dict</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">name</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">setup_cmds</span><span class=\"p\">:</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">env_vars</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">Dict</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">{},</span>\n    <span class=\"n\">working_dir</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">Path</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;./&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">secrets</span><span class=\"p\">:</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"n\">Union</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Secret&quot;</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"p\">[],</span>\n    <span class=\"n\">dryrun</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">False</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;Builds an instance of :class:`CondaEnv`.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        reqs (List[str]): List of package names to install in this environment.</span>\n<span class=\"sd\">        conda_env (Union[str, Dict], optional): Dict representing conda env, Path to a conda env yaml file,</span>\n<span class=\"sd\">            or name of a local conda environment.</span>\n<span class=\"sd\">        name (Optional[str], optional): Name of the environment resource.</span>\n<span class=\"sd\">        setup_cmds (Optional[List[str]]): List of CLI commands to run for setup when the environment is</span>\n<span class=\"sd\">            being set up on a cluster.</span>\n<span class=\"sd\">        env_vars (Dict or str): Dictionary of environment variables, or relative path to .env file containing</span>\n<span class=\"sd\">            environment variables. (Default: {})</span>\n<span class=\"sd\">        working_dir (str or Path): Working directory of the environment, to be loaded onto the system.</span>\n<span class=\"sd\">            (Default: &quot;./&quot;)</span>\n<span class=\"sd\">        dryrun (bool, optional): Whether to run in dryrun mode. (Default: ``False``)</span>\n\n<span class=\"sd\">    Returns:</span>\n<span class=\"sd\">        CondaEnv: The resulting CondaEnv object.</span>\n\n<span class=\"sd\">    Example:</span>\n<span class=\"sd\">        &gt;&gt;&gt; rh.conda_env(reqs=[&quot;torch&quot;])</span>\n<span class=\"sd\">        &gt;&gt;&gt; rh.conda_env(reqs=[&quot;torch&quot;], name=&quot;resource_name&quot;)</span>\n<span class=\"sd\">        &gt;&gt;&gt; rh.conda_env(reqs=[&quot;torch&quot;], name=&quot;resource_name&quot;, conda_env={&quot;name&quot;: &quot;conda_env&quot;})</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">conda_env</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"n\">name</span><span class=\"p\">:</span>\n            <span class=\"n\">conda_env</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s2\">&quot;name&quot;</span><span class=\"p\">:</span> <span class=\"n\">name</span><span class=\"p\">}</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">conda_env</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s2\">&quot;name&quot;</span><span class=\"p\">:</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"s2\">&quot;%Y%m</span><span class=\"si\">%d</span><span class=\"s2\">_%H%M%S&quot;</span><span class=\"p\">)}</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">env</span><span class=\"p\">(</span>\n        <span class=\"n\">reqs</span><span class=\"o\">=</span><span class=\"n\">reqs</span><span class=\"p\">,</span>\n        <span class=\"n\">conda_env</span><span class=\"o\">=</span><span class=\"n\">conda_env</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">,</span>\n        <span class=\"n\">setup_cmds</span><span class=\"o\">=</span><span class=\"n\">setup_cmds</span><span class=\"p\">,</span>\n        <span class=\"n\">env_vars</span><span class=\"o\">=</span><span class=\"n\">env_vars</span><span class=\"p\">,</span>\n        <span class=\"n\">working_dir</span><span class=\"o\">=</span><span class=\"n\">working_dir</span><span class=\"p\">,</span>\n        <span class=\"n\">secrets</span><span class=\"o\">=</span><span class=\"n\">secrets</span><span class=\"p\">,</span>\n        <span class=\"n\">dryrun</span><span class=\"o\">=</span><span class=\"n\">dryrun</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/runhouse/resources/envs/env_factory", "sidebars": ["about.html", "navigation.html", "relations.html", "searchbox.html", "donate.html"], "customsidebar": null, "alabaster_version": "0.7.15", "alabaster_version_info": [0, 7, 15]}