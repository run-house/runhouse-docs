{"parents": [], "prev": {"link": "../../runhouse-in-your-stack/", "title": "Working with Common Libraries and Tools"}, "next": {"link": "../api-modules/", "title": "Functions and Modules"}, "title": "Clusters", "meta": {}, "body": "<section id=\"clusters\">\n<h1>Clusters<a class=\"headerlink\" href=\"#clusters\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p><a href=\"https://colab.research.google.com/github/run-house/notebooks/blob/stable/docs/api-clusters.ipynb\">\n<img height=\"20px\" width=\"117px\" src=\"https://colab.research.google.com/assets/colab-badge.svg\" alt=\"Open In Colab\"/></a></p><p>A cluster is the most basic form of compute in Runhouse, largely\nrepresenting a group of instances or VMs connected with Ray. They\nlargely fall in two categories:</p>\n<ol class=\"arabic simple\">\n<li><p><em>Static Clusters</em>: Any machine you have SSH access to, set up with IP\naddresses and SSH credentials.</p></li>\n<li><p><em>On-Demand Clusters</em>: Any cloud instance spun up automatically for\nyou with your cloud credentials.</p></li>\n</ol>\n<p>Runhouse provides various APIs for interacting with remote clusters,\nsuch as terminating an on-demand cloud cluster or running remote CLI or\nPython commands from your local dev environment.</p>\n<p>Let\u2019s start with a simple example using AWS. First, install <code class=\"docutils literal notranslate\"><span class=\"pre\">runhouse</span></code>\nwith AWS dependencies:</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>! pip install &quot;runhouse[aws]&quot;\n</pre></div>\n</div>\n<p>Make sure your AWS credentials are set up:</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>! aws configure\n! sky check\n</pre></div>\n</div>\n<section id=\"on-demand-clusters\">\n<h2>On-Demand Clusters<a class=\"headerlink\" href=\"#on-demand-clusters\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p>We can start by using the <code class=\"docutils literal notranslate\"><span class=\"pre\">rh.cluster</span></code> factory function to create our\ncluster. By specifying an <code class=\"docutils literal notranslate\"><span class=\"pre\">instance_type</span></code>, Runhouse sets up an\nOn-Demand Cluster in AWS EC2 for us.</p>\n<p>Each cluster must be provided with a unique <code class=\"docutils literal notranslate\"><span class=\"pre\">name</span></code> identifier during\nconstruction. This <code class=\"docutils literal notranslate\"><span class=\"pre\">name</span></code> parameter is used for saving down or loading\nprevious saved clusters, and also used for various CLI commands for the\ncluster.</p>\n<p>Our <code class=\"docutils literal notranslate\"><span class=\"pre\">instance_type</span></code> here is defined as <code class=\"docutils literal notranslate\"><span class=\"pre\">CPU:2</span></code>, which is the\naccelerator type and count that we need (another example would be\n<code class=\"docutils literal notranslate\"><span class=\"pre\">A10G:2</span></code>). We could alternatively specify a specific specific instance\ntype, such as <code class=\"docutils literal notranslate\"><span class=\"pre\">p3.2xlarge</span></code> or <code class=\"docutils literal notranslate\"><span class=\"pre\">g4dn.xlarge</span></code> (these are instance\ntypes on AWS).</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>import runhouse as rh\n\naws_cluster = rh.cluster(name=&quot;test-cluster&quot;, instance_type=&quot;CPU:2&quot;)\naws_cluster.up_if_not()\n</pre></div>\n</div>\n<p>Next, we set up a basic function to throw up on our cluster. For more\ninformation about Functions &amp; Modules that you can put up on a cluster,\nsee <a class=\"reference external\" href=\"https://www.run.house/docs/tutorials/api-modules\">Functions &amp;\nModules</a>.</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>def run_home(name: str):\n    return f&quot;Run home {name}!&quot;\n\nremote_function = rh.function(run_home).to(aws_cluster)\n</pre></div>\n</div>\n<p>After running <code class=\"docutils literal notranslate\"><span class=\"pre\">.to</span></code>, your function is set up on the cluster to be\ncalled from anywhere. When you call <code class=\"docutils literal notranslate\"><span class=\"pre\">remote_function</span></code>, it executes\nremotely on your AWS instance.</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>remote_function(&quot;in cluster!&quot;)\n</pre></div>\n</div>\n<div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2024</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"o\">-</span><span class=\"mi\">06</span> <span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"mf\">58.439252</span> <span class=\"o\">|</span> <span class=\"n\">Calling</span> <span class=\"n\">run_home</span><span class=\"o\">.</span><span class=\"n\">call</span>\n<span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2024</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"o\">-</span><span class=\"mi\">06</span> <span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"mf\">59.490122</span> <span class=\"o\">|</span> <span class=\"n\">Time</span> <span class=\"n\">to</span> <span class=\"n\">call</span> <span class=\"n\">run_home</span><span class=\"o\">.</span><span class=\"n\">call</span><span class=\"p\">:</span> <span class=\"mf\">1.05</span> <span class=\"n\">seconds</span>\n</pre></div>\n</div>\n<div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"s1\">&#39;Run home in cluster!!&#39;</span>\n</pre></div>\n</div>\n<section id=\"on-demand-clusters-within-existing-cloud-vpc\">\n<h3>On-Demand Clusters within Existing Cloud VPC<a class=\"headerlink\" href=\"#on-demand-clusters-within-existing-cloud-vpc\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<p>If you would like to launch on-demand clusters using existing VPCs,\nyou can easily set it up by configuring SkyPilot. Without setting VPC,\nwe launch in the default VPC in the region of the cluster. If you do\nset a VPC name, we will only launch in regions containing that VPC\nname.</p>\n<p>You need to create or update the file <cite>~/.sky/config.yaml</cite> to configure\nthe VPC. For instance in Amazon Web Services, you need to add</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>aws:\n    vpc_name: my-vpc-name\n</pre></div>\n</div>\n<p>And for Google Cloud you need:</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>gcp:\n  vpc_name: my-vpc-name\n</pre></div>\n</div>\n<p>If you need support for more advanced enterprise configurations,\nplease email <a class=\"reference external\" href=\"mailto:support&#37;&#52;&#48;run&#46;house\">support<span>&#64;</span>run<span>&#46;</span>house</a> for more information. More documentation is\nalso available at SkyPilot\u2019s <a class=\"reference external\" href=\"https://skypilot.readthedocs.io/en/latest/reference/config.html\">advanced config page.</a></p>\n</section>\n<section id=\"on-demand-clusters-with-tls-exposed\">\n<h3>On-Demand Clusters with TLS exposed<a class=\"headerlink\" href=\"#on-demand-clusters-with-tls-exposed\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<p>In the previous example, the cluster that was brought up in EC2 is only\naccessible to the original user that has SSH credentials to the machine.\nHowever, you can set up a cluster with ports exposed to open Internet,\nand access objects and functions via <code class=\"docutils literal notranslate\"><span class=\"pre\">curl</span></code>.</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>tls_cluster = rh.cluster(name=&quot;tls-cluster&quot;,\n                         instance_type=&quot;CPU:2&quot;,\n                         open_ports=[443], # expose HTTPS port to public\n                         server_connection_type=&quot;tls&quot;, # specify how runhouse communicates with this cluster\n                         den_auth=False, # no authentication required to hit this cluster (NOT recommended)\n).up_if_not()\n</pre></div>\n</div>\n<pre class=\"code-output literal-block\">WARNING | 2024-03-06 15:19:05.297411 | /Users/rohinbhasin/work/runhouse/runhouse/resources/hardware/on_demand_cluster.py:317: UserWarning: Server is insecure and must be inside a VPC or have <cite>den_auth</cite> enabled to secure it.\n  warnings.warn(</pre>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>remote_tls_function = rh.function(run_home).to(tls_cluster)\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>remote_tls_function(&quot;Marvin&quot;)\n</pre></div>\n</div>\n<div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2024</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"o\">-</span><span class=\"mi\">06</span> <span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">26</span><span class=\"p\">:</span><span class=\"mf\">05.482586</span> <span class=\"o\">|</span> <span class=\"n\">Calling</span> <span class=\"n\">run_home</span><span class=\"o\">.</span><span class=\"n\">call</span>\n<span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2024</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"o\">-</span><span class=\"mi\">06</span> <span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">26</span><span class=\"p\">:</span><span class=\"mf\">06.550625</span> <span class=\"o\">|</span> <span class=\"n\">Time</span> <span class=\"n\">to</span> <span class=\"n\">call</span> <span class=\"n\">run_home</span><span class=\"o\">.</span><span class=\"n\">call</span><span class=\"p\">:</span> <span class=\"mf\">1.07</span> <span class=\"n\">seconds</span>\n</pre></div>\n</div>\n<div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"s1\">&#39;Run home Marvin!&#39;</span>\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>tls_cluster.head_ip\n</pre></div>\n</div>\n<div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"s1\">&#39;54.172.178.196&#39;</span>\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>! curl &quot;https://54.172.178.196/run_home/call?name=Marvin&quot; -k\n</pre></div>\n</div>\n<pre class=\"code-output literal-block\">{&quot;data&quot;:&quot;&quot;Run home Marvin!&quot;&quot;,&quot;error&quot;:null,&quot;traceback&quot;:null,&quot;output_type&quot;:&quot;result_serialized&quot;,&quot;serialization&quot;:&quot;json&quot;}</pre>\n<p>This cluster is exposed to the open Internet, so anyone can hit it. If\nyou do want to share functions and apps publically, it\u2019s recommended you\nset <code class=\"docutils literal notranslate\"><span class=\"pre\">den_auth=True</span></code> when setting up your cluster, which requires a\nuser to run <code class=\"docutils literal notranslate\"><span class=\"pre\">runhouse</span> <span class=\"pre\">login</span></code> in order to hit the cluster. We\u2019ll enable\nit now:</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>tls_cluster.enable_den_auth()\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>! curl &quot;https://54.172.178.196/run_home/call?name=Marvin&quot; -k\n</pre></div>\n</div>\n<pre class=\"code-output literal-block\">{&quot;data&quot;:null,&quot;error&quot;:raise PermissionError(\\nPermissionError: No Runhouse token provided. Try running <cite>$ runhouse login</cite> or visiting <a class=\"reference external\" href=\"https://run.house/login\">https://run.house/login</a> to retrieve a token. If calling via HTTP, please provide a valid token in the Authorization header.\\n&quot;&quot;,&quot;output_type&quot;:&quot;exception&quot;,&quot;serialization&quot;:null}</pre>\n<p>If we send our Runhouse Den token as a header, then the request is\nvalid:</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>! curl &quot;https://54.172.178.196/run_home/call?name=Marvin&quot; -k -H &quot;Authorization: Bearer &lt;YOUR TOKEN HERE&gt;&quot;\n</pre></div>\n</div>\n<pre class=\"code-output literal-block\">{&quot;data&quot;:&quot;&quot;Run home Marvin!&quot;&quot;,&quot;error&quot;:null,&quot;traceback&quot;:null,&quot;output_type&quot;:&quot;result_serialized&quot;,&quot;serialization&quot;:&quot;json&quot;}</pre>\n</section>\n</section>\n<section id=\"static-clusters\">\n<h2>Static Clusters<a class=\"headerlink\" href=\"#static-clusters\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p>If you have existing machines within a VPC that you want to connect to,\nyou can simply provide the IP addresses and path to SSH credentials to\nthe machine.</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>cluster = rh.cluster(  # using private key\n              name=&quot;cpu-cluster-existing&quot;,\n              ips=[&#39;&lt;ip of the cluster&gt;&#39;],\n              ssh_creds={&#39;ssh_user&#39;: &#39;&lt;user&gt;&#39;, &#39;ssh_private_key&#39;:&#39;&lt;path_to_key&gt;&#39;},\n          )\n</pre></div>\n</div>\n</section>\n<section id=\"useful-cluster-functions\">\n<h2>Useful Cluster Functions<a class=\"headerlink\" href=\"#useful-cluster-functions\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>tls_cluster.run([&#39;pip install numpy &amp;&amp; pip freeze | grep numpy&#39;])\n</pre></div>\n</div>\n<div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"ne\">Warning</span><span class=\"p\">:</span> <span class=\"n\">Permanently</span> <span class=\"n\">added</span> <span class=\"s1\">&#39;54.172.178.196&#39;</span> <span class=\"p\">(</span><span class=\"n\">ED25519</span><span class=\"p\">)</span> <span class=\"n\">to</span> <span class=\"n\">the</span> <span class=\"nb\">list</span> <span class=\"n\">of</span> <span class=\"n\">known</span> <span class=\"n\">hosts</span><span class=\"o\">.</span>\n</pre></div>\n</div>\n<div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">Requirement</span> <span class=\"n\">already</span> <span class=\"n\">satisfied</span><span class=\"p\">:</span> <span class=\"n\">numpy</span> <span class=\"ow\">in</span> <span class=\"o\">/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">conda</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">python3</span><span class=\"mf\">.10</span><span class=\"o\">/</span><span class=\"n\">site</span><span class=\"o\">-</span><span class=\"n\">packages</span> <span class=\"p\">(</span><span class=\"mf\">1.26.4</span><span class=\"p\">)</span>\n<span class=\"n\">numpy</span><span class=\"o\">==</span><span class=\"mf\">1.26.4</span>\n</pre></div>\n</div>\n<pre class=\"code-output literal-block\">[(0,\n  'Requirement already satisfied: numpy in /opt/conda/lib/python3.10/site-packages (1.26.4)nnumpy==1.26.4n',\n  &quot;Warning: Permanently added '54.172.178.196' (ED25519) to the list of known hosts.rn&quot;)]</pre>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>tls_cluster.run_python([&#39;import numpy&#39;, &#39;print(numpy.__version__)&#39;])\n</pre></div>\n</div>\n<div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"mf\">1.26.4</span>\n</pre></div>\n</div>\n<pre class=\"code-output literal-block\">[(0, '1.26.4n', '')]</pre>\n</section>\n</section>\n\n    <script type=\"text/x-thebe-config\">\n    {\n        requestKernel: true,\n        binderOptions: {\n            repo: \"binder-examples/jupyter-stacks-datascience\",\n            ref: \"master\",\n        },\n        codeMirrorConfig: {\n            theme: \"abcdef\",\n            mode: \"python\"\n        },\n        kernelOptions: {\n            name: \"python3\",\n            path: \"./tutorials\"\n        },\n        predefinedOutput: true\n    }\n    </script>\n    <script>kernelName = 'python3'</script>", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"], ["tutorials/api-modules", "Functions and Modules", "N", "next"], ["runhouse-in-your-stack", "Working with Common Libraries and Tools", "P", "previous"]], "sourcename": "tutorials/api-clusters.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Clusters</a><ul>\n<li><a class=\"reference internal\" href=\"#on-demand-clusters\">On-Demand Clusters</a><ul>\n<li><a class=\"reference internal\" href=\"#on-demand-clusters-within-existing-cloud-vpc\">On-Demand Clusters within Existing Cloud VPC</a></li>\n<li><a class=\"reference internal\" href=\"#on-demand-clusters-with-tls-exposed\">On-Demand Clusters with TLS exposed</a></li>\n</ul>\n</li>\n<li><a class=\"reference internal\" href=\"#static-clusters\">Static Clusters</a></li>\n<li><a class=\"reference internal\" href=\"#useful-cluster-functions\">Useful Cluster Functions</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "globaltoc": "<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">Getting Started</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/quick-start-cloud/\">Quick Start</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/quick-start-den/\">Den Quick Start</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"how-to-use-runhouse/\">How to Use Runhouse</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"runhouse-in-your-stack/\">Working with Common Libraries and Tools</a></li>\n</ul>\n<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">API Basics</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-clusters/\">Clusters</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-modules/\">Functions and Modules</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-process/\">Processes</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-images/\">Images</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-folders/\">Folders</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-secrets/\">Secrets</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-resources/\">Resource Management</a></li>\n</ul>\n<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">API Reference</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"api/python/\">Python API</a><ul>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/resource/\">Resource</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/function/\">Function</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/cluster/\">Cluster</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/image/\">Image</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/package/\">Package</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/module/\">Module</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/folder/\">Folder</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/secrets/\">Secrets</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/login/\">Login/Logout</a></li>\n</ul>\n</li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"api/cli/\">Command Line Interface</a></li>\n</ul>\n<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">Other Topics</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/async/\">Asynchronous Programming</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"installation/\">Installation and Setup</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"debugging-logging/\">Debugging and Logging</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"docker-setup/\">Docker: Cluster Setup</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"docker-workflows/\">Docker: Dev and Prod Workflows with Runhouse</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"security-and-authentication/\">Security and Authentication</a></li>\n</ul>\n", "current_page_name": "tutorials/api-clusters", "sidebars": ["about.html", "navigation.html", "relations.html", "searchbox.html", "donate.html"], "customsidebar": null, "alabaster_version": "0.7.16", "alabaster_version_info": [0, 7, 16]}