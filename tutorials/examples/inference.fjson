{"parents": [], "prev": {"link": "../../../api/cli/", "title": "Command Line Interface"}, "next": {"link": "../training/", "title": "Training: Transformers"}, "title": "Inference: Stable Diffusion and FLAN-T5", "meta": {}, "body": "<section id=\"inference-stable-diffusion-and-flan-t5\">\n<h1>Inference: Stable Diffusion and FLAN-T5<a class=\"headerlink\" href=\"#inference-stable-diffusion-and-flan-t5\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p><a href=\"https://colab.research.google.com/github/run-house/runhouse/blob/stable/docs/notebooks/examples/inference.ipynb\">\n<img src=\"https://colab.research.google.com/assets/colab-badge.svg\" alt=\"Open In Colab\"/></a></p><p>Runhouse is nothing more than an accessibility and sharing layer into\nyour own cloud compute and data resources. This tutorial demonstrates\nhow to create, setup, and run remote functions on <strong>your own GPU</strong>,\nusing Stable Diffusion inference as an example.</p>\n<p>You can run this on your own cluster, or through a standard cloud\naccount (AWS, GCP, Azure, LambdaLabs). If you do not have any compute or\ncloud accounts set up, we recommend creating a\n<a class=\"reference external\" href=\"https://cloud.lambdalabs.com/\">LambdaLabs</a> account for the easiest\nsetup path.</p>\n<section id=\"table-of-contents\">\n<h2>Table of Contents<a class=\"headerlink\" href=\"#table-of-contents\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<ul class=\"simple\">\n<li><p>Hardware Setup</p></li>\n<li><p>Stable Diffusion on a Cloud GPU in 5 lines of code</p></li>\n<li><p>Faster Stable Diffusion</p></li>\n<li><p>FLAN-T5 Stable Diffusion</p></li>\n</ul>\n</section>\n<section id=\"hardware-setup\">\n<h2>Hardware Setup<a class=\"headerlink\" href=\"#hardware-setup\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<section id=\"install-runhouse\">\n<h3>Install Runhouse<a class=\"headerlink\" href=\"#install-runhouse\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>!pip install runhouse\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>import runhouse as rh\n</pre></div>\n</div>\n<div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">07</span> <span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">37</span><span class=\"p\">:</span><span class=\"mi\">56</span><span class=\"p\">,</span><span class=\"mi\">202</span> <span class=\"o\">|</span> <span class=\"n\">Loaded</span> <span class=\"n\">Runhouse</span> <span class=\"n\">config</span> <span class=\"kn\">from</span> <span class=\"o\">/</span><span class=\"n\">root</span><span class=\"o\">/.</span><span class=\"n\">rh</span><span class=\"o\">/</span><span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">yaml</span>\n<span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">07</span> <span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">37</span><span class=\"p\">:</span><span class=\"mi\">56</span><span class=\"p\">,</span><span class=\"mi\">965</span> <span class=\"o\">|</span> <span class=\"n\">NumExpr</span> <span class=\"n\">defaulting</span> <span class=\"n\">to</span> <span class=\"mi\">2</span> <span class=\"n\">threads</span><span class=\"o\">.</span>\n</pre></div>\n</div>\n</section>\n<section id=\"optional-login-to-runhouse-to-load-in-secrets\">\n<h3>[Optional] Login to Runhouse to load in secrets<a class=\"headerlink\" href=\"#optional-login-to-runhouse-to-load-in-secrets\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>rh.login(download_secrets=True, download_config=True, interactive=True)\n</pre></div>\n</div>\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">\n            ____              __                             @ @ @\n           <span style=\"color: #800080; text-decoration-color: #800080\">/</span> __ \\__  ______  <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">_</span>  ____  __  __________     <span style=\"font-weight: bold\">[]</span>___\n          <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/_/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> __ \\<span style=\"color: #800080; text-decoration-color: #800080\">/</span> __ \\<span style=\"color: #800080; text-decoration-color: #800080\">/</span> __ \\<span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> ___/ _ \\   <span style=\"color: #800080; text-decoration-color: #800080\">/</span>    <span style=\"color: #800080; text-decoration-color: #800080\">/</span>\\____    @@\n         <span style=\"color: #800080; text-decoration-color: #800080\">/</span> _, _/ <span style=\"color: #800080; text-decoration-color: #800080\">/_/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/_/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/_/</span> <span style=\"font-weight: bold\">(</span>__  <span style=\"font-weight: bold\">)</span>  __/  <span style=\"color: #800080; text-decoration-color: #800080\">/_/</span>\\_/<span style=\"color: #800080; text-decoration-color: #800080\">/____/</span>\\  @@@@\n        <span style=\"color: #800080; text-decoration-color: #800080\">/_/</span> |_|\\__,_/_/ <span style=\"color: #800080; text-decoration-color: #800080\">/_/_/</span> <span style=\"color: #800080; text-decoration-color: #800080\">/_/</span>\\____/\\__,_/____/\\___/   | || |||__|||   ||\n\n</pre><pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"color: #808000; text-decoration-color: #808000; font-weight: bold\">Retrieve your token \ud83d\udd11 here to use \ud83c\udfc3 \ud83c\udfe0 Runhouse for secrets and artifact management: </span><a href=\"https://run.house/account#token\" target=\"_blank\"><span style=\"color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline\">https://run.house/account#token</span></a>\n</pre><div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span>Token: \u00b7\u00b7\u00b7\u00b7\u00b7\u00b7\u00b7\u00b7\u00b7\u00b7\nUpload your local config to Runhouse? [y/N]: y\nUpload your enabled cloud provider secrets to Vault? [y/N]: y\nINFO | 2023-02-07 15:39:28,273 | Getting secrets from Vault.\nINFO | 2023-02-07 15:39:29,896 | Found credentials in shared credentials file: ~/.aws/credentials\nINFO | 2023-02-07 15:39:30,765 | Saved secrets from Vault to local config files for providers: [&#39;aws&#39;, &#39;sky&#39;]\nINFO | 2023-02-07 15:39:32,168 | Found credentials in shared credentials file: ~/.aws/credentials\nUpload secrets for aws? [y/N]: y\nUpload secrets for sky? [y/N]: y\nINFO | 2023-02-07 15:39:35,962 | Uploaded secrets for providers [&#39;aws&#39;, &#39;sky&#39;] to Vault\nINFO | 2023-02-07 15:39:35,965 | Successfully logged into Runhouse.\n</pre></div>\n</div>\n</section>\n<section id=\"set-up-runhouse-cluster\">\n<h3>Set up Runhouse cluster<a class=\"headerlink\" href=\"#set-up-runhouse-cluster\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<p>Runhouse leverages SkyPilot for cloud-provider on-demand clusters. If\nusing an on-demand AWS, GCP, Azure, LambdaLabs cluster, run the\n<code class=\"docutils literal notranslate\"><span class=\"pre\">sky</span> <span class=\"pre\">check</span></code> CLI command for instructions on how to set up local\ncredentials for your specified cloud provider(s). You can rerun this\ncommand after setup to check that it has been set up correctly.</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>!sky check\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span># Uncomment if you&#39;re using GCP and running inside Colab!\n# !gcloud init\n# !gcloud auth application-default login\n# !cp -r /content/.config/* ~/.config/gcloud\n</pre></div>\n</div>\n<p>Depending on your cloud provider, uncomment out one of the following\noptions to instantiate your <code class=\"docutils literal notranslate\"><span class=\"pre\">rh-a10x</span></code>, and save it to your rh config.</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span># For GCP, Azure, or Lambda Labs\n# rh.ondemand_cluster(name=&#39;rh-a10x&#39;, instance_type=&#39;A100:1&#39;).save()\n\n# For AWS (single A100s not available, base A10G may have insufficient CPU RAM)\n# rh.ondemand_cluster(name=&#39;rh-a10x&#39;, instance_type=&#39;g5.2xlarge&#39;, provider=&#39;aws&#39;).save()\n\n# To use our own GPU (or from a different provider, e.g. Paperspace, Coreweave)\n# rh.cluster(ips=[&#39;&lt;ip of the cluster&gt;&#39;],\n#            ssh_creds={&#39;ssh_user&#39;: &#39;...&#39;, &#39;ssh_private_key&#39;:&#39;&lt;path_to_key&gt;&#39;},\n#            name=&#39;rh-a10x&#39;).save()\n</pre></div>\n</div>\n<p>Now we\u2019re ready to get started running!</p>\n</section>\n</section>\n<section id=\"stable-diffusion-on-a-cloud-gpu-in-5-lines-of-code\">\n<h2>Stable Diffusion on a Cloud GPU in 5 lines of code<a class=\"headerlink\" href=\"#stable-diffusion-on-a-cloud-gpu-in-5-lines-of-code\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p>We\u2019ll use Runhouse to experiment with Stable Diffusion from your laptop,\nwhile the model actually runs on an A100/A10G in the cloud.</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>gpu = rh.cluster(name=&#39;rh-a10x&#39;)\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>def sd_generate(prompt, num_images=1, steps=100, guidance_scale=7.5, model_id=&#39;stabilityai/stable-diffusion-2-base&#39;):\n    # imports must be defined inside the function for notebook environments\n    from diffusers import StableDiffusionPipeline\n    import torch\n\n    pipe = StableDiffusionPipeline.from_pretrained(model_id, torch_dtype=torch.float16, revision=&#39;fp16&#39;).to(&#39;cuda&#39;)\n    return pipe([prompt] * num_images, num_inference_steps=steps, guidance_scale=guidance_scale).images\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>generate_gpu = rh.function(fn=sd_generate).to(\n    gpu,\n    env=[&#39;./&#39;, &#39;torch --upgrade --extra-index-url https://download.pytorch.org/whl/cu117&#39;, &#39;diffusers&#39;, &#39;transformers&#39;]\n)\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span># for outputting images later\n!pip install ipyplot\nimport ipyplot\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>rh_prompt = &#39;A digital illustration of a woman running on the roof of a house.&#39;\nimages = generate_gpu(rh_prompt, num_images=4, steps=50)\n\nipyplot.plot_images(images)\n</pre></div>\n</div>\n<pre class=\"code-output literal-block\">INFO | 2023-02-07 16:10:42,374 | Running sd_generate via gRPC\nINFO | 2023-02-07 16:11:27,874 | Time to send message: 45.5 seconds\nWARNING | 2023-02-07 16:11:27,885 | /usr/local/lib/python3.8/dist-packages/ipyplot/_utils.py:95: FutureWarning: The input object of type 'Image' is an array-like implementing one of the corresponding protocols (<cite>__array__</cite>, <cite>__array_interface__</cite> or <cite>__array_struct__</cite>); but not a sequence (or 0-D). In the future, this object will be coerced as if it was first converted using <cite>np.array(obj)</cite>. To retain the old behaviour, you have to either modify the type 'Image', or assign to an empty array created with <cite>np.empty(correct_shape, dtype=object)</cite>.\n  return np.asarray(seq, dtype=type(seq[0]))</pre>\n<style>\n    #ipyplot-html-viewer-toggle-WhhNeRcdRs43RrEUjLWLiB {\n        position: absolute;\n        top: -9999px;\n        left: -9999px;\n        visibility: hidden;\n    }\n\n    #ipyplot-html-viewer-label-WhhNeRcdRs43RrEUjLWLiB {\n        position: relative;\n        display: inline-block;\n        cursor: pointer;\n        color: blue;\n        text-decoration: underline;\n    }\n\n    #ipyplot-html-viewer-textarea-WhhNeRcdRs43RrEUjLWLiB {\n        background: lightgrey;\n        width: 100%;\n        height: 0px;\n        display: none;\n    }\n\n    #ipyplot-html-viewer-toggle-WhhNeRcdRs43RrEUjLWLiB:checked ~ #ipyplot-html-viewer-textarea-WhhNeRcdRs43RrEUjLWLiB {\n        height: 200px;\n        display: block;\n    }\n\n    #ipyplot-html-viewer-toggle-WhhNeRcdRs43RrEUjLWLiB:checked + #ipyplot-html-viewer-label-WhhNeRcdRs43RrEUjLWLiB:after {\n        content: \"hide html\";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: white;\n        cursor: pointer;\n        color: blue;\n        text-decoration: underline;\n    }\n</style>\n<div>\n    <input type=\"checkbox\" id=\"ipyplot-html-viewer-toggle-WhhNeRcdRs43RrEUjLWLiB\">\n    <label id=\"ipyplot-html-viewer-label-WhhNeRcdRs43RrEUjLWLiB\" for=\"ipyplot-html-viewer-toggle-WhhNeRcdRs43RrEUjLWLiB\">show html</label>\n    <textarea id=\"ipyplot-html-viewer-textarea-WhhNeRcdRs43RrEUjLWLiB\" readonly>\n\n    <style>\n    #ipyplot-imgs-container-div-ciwsTsagCbGynZrGzcK5cc {\n        width: 100%;\n        height: 100%;\n        margin: 0%;\n        overflow: auto;\n        position: relative;\n        overflow-y: scroll;\n    }\n\n    div.ipyplot-placeholder-div-ciwsTsagCbGynZrGzcK5cc {\n        width: 150px;\n        display: inline-block;\n        margin: 3px;\n        position: relative;\n    }\n\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc {\n        width: 150px;\n        background: white;\n        display: inline-block;\n        vertical-align: top;\n        text-align: center;\n        position: relative;\n        border: 2px solid #ddd;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc span.ipyplot-img-close {\n        display: none;\n    }\n\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc span {\n        width: 100%;\n        height: 100%;\n        position: absolute;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc img {\n        width: 150px;\n    }\n\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc span.ipyplot-img-close:hover {\n        cursor: zoom-out;\n    }\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc span.ipyplot-img-expand:hover {\n        cursor: zoom-in;\n    }\n\n    div[id^=ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc]:target {\n        transform: scale(2.5);\n        transform-origin: left top;\n        z-index: 5000;\n        top: 0;\n        left: 0;\n        position: absolute;\n    }\n\n    div[id^=ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc]:target span.ipyplot-img-close {\n        display: block;\n    }\n\n    div[id^=ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc]:target span.ipyplot-img-expand {\n        display: none;\n    }\n    </style>\n<div id=\"ipyplot-imgs-container-div-ciwsTsagCbGynZrGzcK5cc\">\n<div class=\"ipyplot-placeholder-div-ciwsTsagCbGynZrGzcK5cc\">\n    <div id=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-DXJFBL2Rm6vZ4T4kcCvGyv\" class=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">0</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/sd_0.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-DXJFBL2Rm6vZ4T4kcCvGyv\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ciwsTsagCbGynZrGzcK5cc\">\n    <div id=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-MoGxsQQg5t2VXMZnYGaNqD\" class=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">1</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/sd_1.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-MoGxsQQg5t2VXMZnYGaNqD\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ciwsTsagCbGynZrGzcK5cc\">\n    <div id=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-H8bdZVYWHTKpowowURxzdu\" class=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">2</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/sd_2.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-H8bdZVYWHTKpowowURxzdu\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ciwsTsagCbGynZrGzcK5cc\">\n    <div id=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-idzjZHiuzvWESgu9PPssMx\" class=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">3</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/sd_3.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-idzjZHiuzvWESgu9PPssMx\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n</div>\n    </textarea>\n</div>    <style>\n    #ipyplot-imgs-container-div-ciwsTsagCbGynZrGzcK5cc {\n        width: 100%;\n        height: 100%;\n        margin: 0%;\n        overflow: auto;\n        position: relative;\n        overflow-y: scroll;\n    }\n\n    div.ipyplot-placeholder-div-ciwsTsagCbGynZrGzcK5cc {\n        width: 150px;\n        display: inline-block;\n        margin: 3px;\n        position: relative;\n    }\n\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc {\n        width: 150px;\n        background: white;\n        display: inline-block;\n        vertical-align: top;\n        text-align: center;\n        position: relative;\n        border: 2px solid #ddd;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc span.ipyplot-img-close {\n        display: none;\n    }\n\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc span {\n        width: 100%;\n        height: 100%;\n        position: absolute;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc img {\n        width: 150px;\n    }\n\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc span.ipyplot-img-close:hover {\n        cursor: zoom-out;\n    }\n    div.ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc span.ipyplot-img-expand:hover {\n        cursor: zoom-in;\n    }\n\n    div[id^=ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc]:target {\n        transform: scale(2.5);\n        transform-origin: left top;\n        z-index: 5000;\n        top: 0;\n        left: 0;\n        position: absolute;\n    }\n\n    div[id^=ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc]:target span.ipyplot-img-close {\n        display: block;\n    }\n\n    div[id^=ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc]:target span.ipyplot-img-expand {\n        display: none;\n    }\n    </style>\n<div id=\"ipyplot-imgs-container-div-ciwsTsagCbGynZrGzcK5cc\">\n<div class=\"ipyplot-placeholder-div-ciwsTsagCbGynZrGzcK5cc\">\n    <div id=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-DXJFBL2Rm6vZ4T4kcCvGyv\" class=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">0</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/sd_0.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-DXJFBL2Rm6vZ4T4kcCvGyv\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ciwsTsagCbGynZrGzcK5cc\">\n    <div id=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-MoGxsQQg5t2VXMZnYGaNqD\" class=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">1</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/sd_1.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-MoGxsQQg5t2VXMZnYGaNqD\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ciwsTsagCbGynZrGzcK5cc\">\n    <div id=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-H8bdZVYWHTKpowowURxzdu\" class=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">2</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/sd_2.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-H8bdZVYWHTKpowowURxzdu\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ciwsTsagCbGynZrGzcK5cc\">\n    <div id=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-idzjZHiuzvWESgu9PPssMx\" class=\"ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">3</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/sd_3.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ciwsTsagCbGynZrGzcK5cc-idzjZHiuzvWESgu9PPssMx\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n</div><div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span># save the function to be reusable later on\ngenerate_gpu.save(name=&#39;sd_generate&#39;)\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span># By default, the GPU will terminate after 30 min of inactivity.\n# To keep it up to reuse it for the rest of the tutorials\ngpu.keep_warm()\n\n# To stop the cluster after 10 min of inactivity\n# gpu.keep_warm(autostop_mins=10)\n\n# To terminate the cluster through runhouse. It can also be terminated directly through the cloud provider\n# or by using the CLI commands `sky down gpu` or `sky down --all`\n# gpu.teardown()\n</pre></div>\n</div>\n</section>\n<section id=\"faster-stable-diffusion\">\n<h2>Faster Stable Diffusion<a class=\"headerlink\" href=\"#faster-stable-diffusion\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p>The previous function will load the pretrained model every time the\nfunction is run. In this section, we demonstrate two ways to reuse the\nloaded model on the GPU to bring down the time to run Stable Diffusion.</p>\n<section id=\"load-retrieve-from-object-store\">\n<h3>Load/Retrieve from Object Store<a class=\"headerlink\" href=\"#load-retrieve-from-object-store\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<p>The first approach uses <code class=\"docutils literal notranslate\"><span class=\"pre\">rh.here.put()</span></code> and <code class=\"docutils literal notranslate\"><span class=\"pre\">rh.here.get()</span></code> to save\ndown and later retrieve the model from your Runhouse object store. The\nmodel will be still need to be loaded the first run to be put in memory,\nso speed-ups will only be observed in future runs.</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>def sd_generate_pinned(prompt, num_images=1, steps=100, guidance_scale=7.5,\n                       model_id=&#39;stabilityai/stable-diffusion-2-base&#39;,\n                       revision=&quot;fp16&quot;):\n    import torch\n    import runhouse as rh\n    from diffusers import StableDiffusionPipeline, DDIMScheduler\n\n    pipe = rh.get_pinned_object(model_id)\n\n    # pin to memory if it is not in memory yet\n    if pipe is None:\n        pipe = StableDiffusionPipeline.from_pretrained(model_id, torch_dtype=torch.float16, revision=revision).to(&quot;cuda&quot;)\n        pipe.scheduler = DDIMScheduler.from_config(pipe.scheduler.config)\n        rh.pin_to_memory(model_id, pipe)\n\n    return pipe(prompt, num_images_per_prompt=num_images,\n                num_inference_steps=steps, guidance_scale=guidance_scale).images\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>generate_pinned_gpu = rh.function(fn=sd_generate_pinned).to(gpu).save(&quot;sd_generate_pinned&quot;)\nmy_prompt = &#39;A hot dog made of matcha powder.&#39;\nmatcha_images = generate_pinned_gpu(my_prompt, num_images=4, steps=50)\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>ipyplot.plot_images(matcha_images)\n</pre></div>\n</div>\n<pre class=\"code-output literal-block\">WARNING | 2023-02-07 16:29:32,700 | /usr/local/lib/python3.8/dist-packages/ipyplot/_utils.py:95: FutureWarning: The input object of type 'Image' is an array-like implementing one of the corresponding protocols (<cite>__array__</cite>, <cite>__array_interface__</cite> or <cite>__array_struct__</cite>); but not a sequence (or 0-D). In the future, this object will be coerced as if it was first converted using <cite>np.array(obj)</cite>. To retain the old behaviour, you have to either modify the type 'Image', or assign to an empty array created with <cite>np.empty(correct_shape, dtype=object)</cite>.\n  return np.asarray(seq, dtype=type(seq[0]))</pre>\n<style>\n    #ipyplot-html-viewer-toggle-SdbGRnYFKgEsQ8iX6tTzJn {\n        position: absolute;\n        top: -9999px;\n        left: -9999px;\n        visibility: hidden;\n    }\n\n    #ipyplot-html-viewer-label-SdbGRnYFKgEsQ8iX6tTzJn {\n        position: relative;\n        display: inline-block;\n        cursor: pointer;\n        color: blue;\n        text-decoration: underline;\n    }\n\n    #ipyplot-html-viewer-textarea-SdbGRnYFKgEsQ8iX6tTzJn {\n        background: lightgrey;\n        width: 100%;\n        height: 0px;\n        display: none;\n    }\n\n    #ipyplot-html-viewer-toggle-SdbGRnYFKgEsQ8iX6tTzJn:checked ~ #ipyplot-html-viewer-textarea-SdbGRnYFKgEsQ8iX6tTzJn {\n        height: 200px;\n        display: block;\n    }\n\n    #ipyplot-html-viewer-toggle-SdbGRnYFKgEsQ8iX6tTzJn:checked + #ipyplot-html-viewer-label-SdbGRnYFKgEsQ8iX6tTzJn:after {\n        content: \"hide html\";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: white;\n        cursor: pointer;\n        color: blue;\n        text-decoration: underline;\n    }\n</style>\n<div>\n    <input type=\"checkbox\" id=\"ipyplot-html-viewer-toggle-SdbGRnYFKgEsQ8iX6tTzJn\">\n    <label id=\"ipyplot-html-viewer-label-SdbGRnYFKgEsQ8iX6tTzJn\" for=\"ipyplot-html-viewer-toggle-SdbGRnYFKgEsQ8iX6tTzJn\">show html</label>\n    <textarea id=\"ipyplot-html-viewer-textarea-SdbGRnYFKgEsQ8iX6tTzJn\" readonly>\n\n    <style>\n    #ipyplot-imgs-container-div-7j3Fk4SG4Jwxoafp6tRuiB {\n        width: 100%;\n        height: 100%;\n        margin: 0%;\n        overflow: auto;\n        position: relative;\n        overflow-y: scroll;\n    }\n\n    div.ipyplot-placeholder-div-7j3Fk4SG4Jwxoafp6tRuiB {\n        width: 150px;\n        display: inline-block;\n        margin: 3px;\n        position: relative;\n    }\n\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB {\n        width: 150px;\n        background: white;\n        display: inline-block;\n        vertical-align: top;\n        text-align: center;\n        position: relative;\n        border: 2px solid #ddd;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB span.ipyplot-img-close {\n        display: none;\n    }\n\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB span {\n        width: 100%;\n        height: 100%;\n        position: absolute;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB img {\n        width: 150px;\n    }\n\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB span.ipyplot-img-close:hover {\n        cursor: zoom-out;\n    }\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB span.ipyplot-img-expand:hover {\n        cursor: zoom-in;\n    }\n\n    div[id^=ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB]:target {\n        transform: scale(2.5);\n        transform-origin: left top;\n        z-index: 5000;\n        top: 0;\n        left: 0;\n        position: absolute;\n    }\n\n    div[id^=ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB]:target span.ipyplot-img-close {\n        display: block;\n    }\n\n    div[id^=ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB]:target span.ipyplot-img-expand {\n        display: none;\n    }\n    </style>\n<div id=\"ipyplot-imgs-container-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n<div class=\"ipyplot-placeholder-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n    <div id=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-5aCbbqqDJtgDsv3xRXWWr8\" class=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">0</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/pin_0.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-5aCbbqqDJtgDsv3xRXWWr8\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n    <div id=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-89y7xSULgpfyqd9QX8X9sf\" class=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">1</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/pin_1.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-89y7xSULgpfyqd9QX8X9sf\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n    <div id=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-XDXTQZXDutnkP2UeJ89UQE\" class=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">2</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/pin_2.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-XDXTQZXDutnkP2UeJ89UQE\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n    <div id=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-g5ofaCEvZ4UHffLp3H6evR\" class=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">3</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/pin_3.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-g5ofaCEvZ4UHffLp3H6evR\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n</div>\n    </textarea>\n</div>    <style>\n    #ipyplot-imgs-container-div-7j3Fk4SG4Jwxoafp6tRuiB {\n        width: 100%;\n        height: 100%;\n        margin: 0%;\n        overflow: auto;\n        position: relative;\n        overflow-y: scroll;\n    }\n\n    div.ipyplot-placeholder-div-7j3Fk4SG4Jwxoafp6tRuiB {\n        width: 150px;\n        display: inline-block;\n        margin: 3px;\n        position: relative;\n    }\n\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB {\n        width: 150px;\n        background: white;\n        display: inline-block;\n        vertical-align: top;\n        text-align: center;\n        position: relative;\n        border: 2px solid #ddd;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB span.ipyplot-img-close {\n        display: none;\n    }\n\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB span {\n        width: 100%;\n        height: 100%;\n        position: absolute;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB img {\n        width: 150px;\n    }\n\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB span.ipyplot-img-close:hover {\n        cursor: zoom-out;\n    }\n    div.ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB span.ipyplot-img-expand:hover {\n        cursor: zoom-in;\n    }\n\n    div[id^=ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB]:target {\n        transform: scale(2.5);\n        transform-origin: left top;\n        z-index: 5000;\n        top: 0;\n        left: 0;\n        position: absolute;\n    }\n\n    div[id^=ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB]:target span.ipyplot-img-close {\n        display: block;\n    }\n\n    div[id^=ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB]:target span.ipyplot-img-expand {\n        display: none;\n    }\n    </style>\n<div id=\"ipyplot-imgs-container-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n<div class=\"ipyplot-placeholder-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n    <div id=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-5aCbbqqDJtgDsv3xRXWWr8\" class=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">0</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/pin_0.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-5aCbbqqDJtgDsv3xRXWWr8\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n    <div id=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-89y7xSULgpfyqd9QX8X9sf\" class=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">1</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/pin_1.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-89y7xSULgpfyqd9QX8X9sf\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n    <div id=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-XDXTQZXDutnkP2UeJ89UQE\" class=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">2</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/pin_2.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-XDXTQZXDutnkP2UeJ89UQE\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n    <div id=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-g5ofaCEvZ4UHffLp3H6evR\" class=\"ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">3</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/pin_3.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-7j3Fk4SG4Jwxoafp6tRuiB-g5ofaCEvZ4UHffLp3H6evR\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n</div></section>\n<section id=\"runhouse-module\">\n<h3>Runhouse Module<a class=\"headerlink\" href=\"#runhouse-module\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<p>The second approach constructs a Runhouse Module that maintains the\nmodel as a class variable. In notebook settings, we define this Module\nin another file and import it here.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span> <span class=\"c1\"># sd_model.py</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">runhouse</span> <span class=\"k\">as</span> <span class=\"nn\">rh</span>\n<span class=\"kn\">import</span> <span class=\"nn\">torch</span>\n<span class=\"kn\">from</span> <span class=\"nn\">diffusers</span> <span class=\"kn\">import</span> <span class=\"n\">StableDiffusionPipeline</span>\n\n<span class=\"k\">class</span> <span class=\"nc\">SDModel</span><span class=\"p\">(</span><span class=\"n\">rh</span><span class=\"o\">.</span><span class=\"n\">Module</span><span class=\"p\">):</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model_id</span><span class=\"o\">=</span><span class=\"s1\">&#39;stabilityai/stable-diffusion-2-base&#39;</span><span class=\"p\">,</span>\n                       <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"n\">torch</span><span class=\"o\">.</span><span class=\"n\">float16</span><span class=\"p\">,</span> <span class=\"n\">revision</span><span class=\"o\">=</span><span class=\"s2\">&quot;fp16&quot;</span><span class=\"p\">,</span> <span class=\"n\">device</span><span class=\"o\">=</span><span class=\"s2\">&quot;cuda&quot;</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model_id</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dtype</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">revision</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">device</span> <span class=\"o\">=</span> <span class=\"n\">model_id</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"p\">,</span> <span class=\"n\">revision</span><span class=\"p\">,</span> <span class=\"n\">device</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">pipeline</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"s1\">&#39;_pipeline&#39;</span><span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_pipeline</span> <span class=\"o\">=</span> <span class=\"n\">StableDiffusionPipeline</span><span class=\"o\">.</span><span class=\"n\">from_pretrained</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model_id</span><span class=\"p\">,</span> <span class=\"n\">torch_dtype</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dtype</span><span class=\"p\">,</span> <span class=\"n\">revision</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">revision</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">to</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">device</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_pipeline</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">predict</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">prompt</span><span class=\"p\">,</span> <span class=\"n\">num_images</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">steps</span><span class=\"o\">=</span><span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"n\">guidance_scale</span><span class=\"o\">=</span><span class=\"mf\">7.5</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">pipeline</span><span class=\"p\">(</span><span class=\"n\">prompt</span><span class=\"p\">,</span> <span class=\"n\">num_images_per_prompt</span><span class=\"o\">=</span><span class=\"n\">num_images</span><span class=\"p\">,</span>\n                             <span class=\"n\">num_inference_steps</span><span class=\"o\">=</span><span class=\"n\">steps</span><span class=\"p\">,</span> <span class=\"n\">guidance_scale</span><span class=\"o\">=</span><span class=\"n\">guidance_scale</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">images</span>\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>from sd_model import SDModel\n\nmodel = SDModel()\nmodel_gpu = model.to(system=gpu)\n\nmodule_images = model_gpu.predict(&#39;my_prompt&#39;, num_images=4, steps=50)\n</pre></div>\n</div>\n</section>\n</section>\n<section id=\"flan-t5-stable-diffusion\">\n<h2>FLAN-T5 Stable Diffusion<a class=\"headerlink\" href=\"#flan-t5-stable-diffusion\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p>Here, we use FLAN-T5, a text-to-text generation model, to generate\nprompts for us. We\u2019ll send a FLAN-T5 inference function to our GPU, and\nthen pipe the outputs into our Stable Diffusion service.</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>def causal_lm_generate(prompt, model_id=&#39;google/flan-t5-xl&#39;, **model_kwargs):\n    import runhouse as rh\n    from transformers import AutoModelForSeq2SeqLM, AutoTokenizer\n\n    (tokenizer, model) = rh.get_pinned_object(model_id) or (None, None)\n\n    # pin to memory if it is not in memory yet\n    if model is None:\n        tokenizer = AutoTokenizer.from_pretrained(model_id)\n        model = AutoModelForSeq2SeqLM.from_pretrained(model_id).to(&#39;cuda&#39;)\n        rh.pin_to_memory(model_id, (tokenizer, model))\n    inputs = tokenizer(prompt, return_tensors=&quot;pt&quot;).to(&#39;cuda&#39;)\n    outputs = model.generate(**inputs, **model_kwargs)\n    return tokenizer.batch_decode(outputs, skip_special_tokens=True)\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>flan_t5_generate = rh.function(fn=causal_lm_generate).to(gpu, env=[&#39;./&#39;])\n</pre></div>\n</div>\n<div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">07</span> <span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">17</span><span class=\"p\">,</span><span class=\"mi\">183</span> <span class=\"o\">|</span> <span class=\"n\">Writing</span> <span class=\"n\">out</span> <span class=\"n\">function</span> <span class=\"n\">to</span> <span class=\"o\">/</span><span class=\"n\">content</span><span class=\"o\">/</span><span class=\"n\">send_fn</span><span class=\"o\">.</span><span class=\"n\">py</span> <span class=\"k\">as</span> <span class=\"n\">functions</span> <span class=\"n\">serialized</span> <span class=\"ow\">in</span> <span class=\"n\">notebooks</span> <span class=\"n\">are</span> <span class=\"n\">brittle</span><span class=\"o\">.</span> <span class=\"n\">Please</span> <span class=\"n\">make</span> <span class=\"n\">sure</span> <span class=\"n\">the</span> <span class=\"n\">function</span> <span class=\"n\">does</span> <span class=\"ow\">not</span> <span class=\"n\">rely</span> <span class=\"n\">on</span> <span class=\"nb\">any</span> <span class=\"n\">local</span> <span class=\"n\">variables</span><span class=\"p\">,</span> <span class=\"n\">including</span> <span class=\"n\">imports</span> <span class=\"p\">(</span><span class=\"n\">which</span> <span class=\"n\">should</span> <span class=\"n\">be</span> <span class=\"n\">moved</span> <span class=\"n\">inside</span> <span class=\"n\">the</span> <span class=\"n\">function</span> <span class=\"n\">body</span><span class=\"p\">)</span><span class=\"o\">.</span>\n<span class=\"n\">WARNING</span> <span class=\"o\">|</span> <span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">07</span> <span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">17</span><span class=\"p\">,</span><span class=\"mi\">186</span> <span class=\"o\">|</span> <span class=\"n\">You</span> <span class=\"n\">should</span> <span class=\"n\">name</span> <span class=\"n\">Functions</span> <span class=\"n\">that</span> <span class=\"n\">are</span> <span class=\"n\">created</span> <span class=\"ow\">in</span> <span class=\"n\">notebooks</span> <span class=\"n\">to</span> <span class=\"n\">avoid</span> <span class=\"n\">naming</span> <span class=\"n\">collisions</span> <span class=\"n\">between</span> <span class=\"n\">the</span> <span class=\"n\">modules</span> <span class=\"n\">that</span> <span class=\"n\">are</span> <span class=\"n\">created</span> <span class=\"n\">to</span> <span class=\"n\">hold</span> <span class=\"n\">their</span> <span class=\"n\">functions</span> <span class=\"p\">(</span><span class=\"n\">i</span><span class=\"o\">.</span><span class=\"n\">e</span><span class=\"o\">.</span> <span class=\"s2\">&quot;send_fn.py&quot;</span> <span class=\"n\">errors</span><span class=\"o\">.</span>\n<span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">07</span> <span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">17</span><span class=\"p\">,</span><span class=\"mi\">197</span> <span class=\"o\">|</span> <span class=\"n\">Setting</span> <span class=\"n\">up</span> <span class=\"n\">Function</span> <span class=\"n\">on</span> <span class=\"n\">cluster</span><span class=\"o\">.</span>\n<span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">07</span> <span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">17</span><span class=\"p\">,</span><span class=\"mi\">204</span> <span class=\"o\">|</span> <span class=\"n\">Copying</span> <span class=\"n\">local</span> <span class=\"n\">package</span> <span class=\"n\">content</span> <span class=\"n\">to</span> <span class=\"n\">cluster</span> <span class=\"o\">&lt;</span><span class=\"n\">rh</span><span class=\"o\">-</span><span class=\"n\">a10x</span><span class=\"o\">-</span><span class=\"n\">aws</span><span class=\"o\">&gt;</span>\n<span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">07</span> <span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">17</span><span class=\"p\">,</span><span class=\"mi\">206</span> <span class=\"o\">|</span> <span class=\"n\">Creating</span> <span class=\"n\">new</span> <span class=\"n\">ssh</span> <span class=\"n\">folder</span><span class=\"p\">:</span> <span class=\"n\">content</span>\n<span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">07</span> <span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">17</span><span class=\"p\">,</span><span class=\"mi\">514</span> <span class=\"o\">|</span> <span class=\"n\">Installing</span> <span class=\"n\">packages</span> <span class=\"n\">on</span> <span class=\"n\">cluster</span> <span class=\"n\">rh</span><span class=\"o\">-</span><span class=\"n\">a10x</span><span class=\"o\">-</span><span class=\"n\">aws</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">]</span>\n<span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">07</span> <span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">17</span><span class=\"p\">,</span><span class=\"mi\">558</span> <span class=\"o\">|</span> <span class=\"n\">Function</span> <span class=\"n\">setup</span> <span class=\"n\">complete</span><span class=\"o\">.</span>\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>my_prompt = &quot;A detailed oil painting of&quot;\nsequences = flan_t5_generate(my_prompt, max_new_tokens=100, min_length=20, temperature=2.0, repetition_penalty=3.0,\n                              use_cache=False, do_sample=True, num_beams=3, num_return_sequences=4)\n\nfull_seqs = [my_prompt + &quot; &quot; + seq for seq in sequences]\nfor seq in full_seqs:\n  print(seq)\n</pre></div>\n</div>\n<div class=\"code-output highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">07</span> <span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">19</span><span class=\"p\">,</span><span class=\"mi\">115</span> <span class=\"o\">|</span> <span class=\"n\">Running</span> <span class=\"n\">causal_lm_generate</span> <span class=\"n\">via</span> <span class=\"n\">gRPC</span>\n<span class=\"n\">INFO</span> <span class=\"o\">|</span> <span class=\"mi\">2023</span><span class=\"o\">-</span><span class=\"mi\">02</span><span class=\"o\">-</span><span class=\"mi\">07</span> <span class=\"mi\">16</span><span class=\"p\">:</span><span class=\"mi\">19</span><span class=\"p\">:</span><span class=\"mi\">04</span><span class=\"p\">,</span><span class=\"mi\">544</span> <span class=\"o\">|</span> <span class=\"n\">Time</span> <span class=\"n\">to</span> <span class=\"n\">send</span> <span class=\"n\">message</span><span class=\"p\">:</span> <span class=\"mf\">225.42</span> <span class=\"n\">seconds</span>\n<span class=\"n\">A</span> <span class=\"n\">detailed</span> <span class=\"n\">oil</span> <span class=\"n\">painting</span> <span class=\"n\">of</span> <span class=\"n\">an</span> <span class=\"n\">ancient</span> <span class=\"n\">Greek</span> <span class=\"n\">vase</span> <span class=\"ow\">in</span> <span class=\"n\">a</span> <span class=\"n\">medieval</span> <span class=\"n\">gallery</span> <span class=\"k\">with</span> <span class=\"n\">two</span> <span class=\"n\">candlesticks</span> <span class=\"n\">on</span> <span class=\"ow\">and</span> <span class=\"n\">some</span> <span class=\"n\">sort</span> <span class=\"n\">of</span> <span class=\"n\">pedestal</span><span class=\"o\">.</span> <span class=\"n\">It</span> <span class=\"ow\">is</span> <span class=\"n\">signed</span> <span class=\"n\">at</span> <span class=\"n\">lower</span> <span class=\"n\">right</span> <span class=\"s2\">&quot;C.P.&quot;</span> <span class=\"p\">(</span><span class=\"n\">probably</span> <span class=\"n\">the</span> <span class=\"n\">same</span> <span class=\"n\">signature</span> <span class=\"n\">used</span> <span class=\"n\">by</span> <span class=\"n\">the</span> <span class=\"n\">artist</span><span class=\"p\">)</span><span class=\"o\">.</span>\n<span class=\"n\">A</span> <span class=\"n\">detailed</span> <span class=\"n\">oil</span> <span class=\"n\">painting</span> <span class=\"n\">of</span> <span class=\"n\">a</span> <span class=\"n\">rose</span> <span class=\"ow\">in</span> <span class=\"n\">the</span> <span class=\"n\">sun</span><span class=\"o\">.</span> <span class=\"n\">This</span> <span class=\"n\">beautiful</span> <span class=\"n\">flower</span> <span class=\"ow\">is</span> <span class=\"n\">known</span> <span class=\"k\">as</span> <span class=\"n\">an</span> <span class=\"n\">achile</span><span class=\"p\">,</span> <span class=\"n\">which</span> <span class=\"n\">means</span> <span class=\"n\">that</span> <span class=\"n\">it</span> <span class=\"n\">can</span> <span class=\"n\">only</span> <span class=\"n\">be</span> <span class=\"n\">seen</span> <span class=\"n\">by</span> <span class=\"n\">night</span><span class=\"o\">-</span><span class=\"n\">time</span> <span class=\"n\">predators</span> <span class=\"n\">like</span> <span class=\"n\">crows</span> <span class=\"ow\">and</span> <span class=\"n\">robins</span><span class=\"o\">.</span> <span class=\"n\">In</span> <span class=\"n\">this</span> <span class=\"n\">painting</span> <span class=\"n\">you</span><span class=\"s1\">&#39;ll notice all sorts of details on the leaves (that are not actually green), flowers, and butterflies. It&#39;</span><span class=\"n\">s</span> <span class=\"n\">a</span> <span class=\"n\">small</span> <span class=\"n\">but</span> <span class=\"n\">lovely</span> <span class=\"n\">detail</span> <span class=\"k\">for</span> <span class=\"n\">someone</span> <span class=\"n\">who</span> <span class=\"n\">wants</span> <span class=\"n\">to</span> <span class=\"n\">have</span> <span class=\"n\">their</span> <span class=\"n\">art</span> <span class=\"n\">work</span> <span class=\"n\">professionally</span> <span class=\"n\">done</span><span class=\"o\">.</span>\n<span class=\"n\">A</span> <span class=\"n\">detailed</span> <span class=\"n\">oil</span> <span class=\"n\">painting</span> <span class=\"n\">of</span> <span class=\"n\">horses</span> <span class=\"ow\">and</span> <span class=\"n\">a</span> <span class=\"n\">cart</span> <span class=\"n\">on</span> <span class=\"n\">an</span> <span class=\"n\">idyllic</span> <span class=\"n\">country</span> <span class=\"n\">farm</span><span class=\"o\">.</span> <span class=\"n\">Painted</span> <span class=\"ow\">in</span> <span class=\"mi\">1880</span> <span class=\"n\">by</span> <span class=\"n\">the</span> <span class=\"n\">painter</span><span class=\"p\">,</span> <span class=\"n\">Auguste</span> <span class=\"n\">Bresson</span> <span class=\"p\">(</span><span class=\"mi\">1845</span><span class=\"o\">-</span><span class=\"mi\">1925</span><span class=\"p\">),</span> <span class=\"k\">for</span> <span class=\"n\">his</span> <span class=\"n\">own</span> <span class=\"n\">private</span> <span class=\"n\">collection</span><span class=\"p\">;</span> <span class=\"n\">over</span> <span class=\"n\">time</span> <span class=\"n\">it</span> <span class=\"n\">became</span> <span class=\"n\">part</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">Art</span> <span class=\"n\">Gallery</span> <span class=\"n\">of</span> <span class=\"n\">Victoria</span><span class=\"s1\">&#39;s permanent collection.</span>\n<span class=\"n\">A</span> <span class=\"n\">detailed</span> <span class=\"n\">oil</span> <span class=\"n\">painting</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">ancient</span> <span class=\"n\">greek</span> <span class=\"n\">god</span><span class=\"p\">,</span> <span class=\"n\">who</span> <span class=\"ow\">is</span> <span class=\"n\">believed</span> <span class=\"n\">to</span> <span class=\"n\">have</span> <span class=\"n\">given</span> <span class=\"n\">his</span> <span class=\"n\">sons</span> <span class=\"ow\">and</span> <span class=\"n\">daughters</span> <span class=\"n\">knowledge</span> <span class=\"n\">of</span> <span class=\"n\">magic</span> <span class=\"n\">tricks</span> <span class=\"ow\">in</span> <span class=\"n\">order</span> <span class=\"k\">for</span> <span class=\"n\">them</span> <span class=\"n\">to</span> <span class=\"n\">excel</span> <span class=\"ow\">in</span> <span class=\"n\">their</span> <span class=\"n\">art</span> <span class=\"p\">(</span><span class=\"n\">the</span> <span class=\"n\">sorcerers</span> <span class=\"n\">were</span> <span class=\"n\">known</span> <span class=\"k\">as</span> <span class=\"n\">oracles</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span># We can directly access the function by the name we saved it by, even on a different environment or run\nsaved_sd_generate = rh.function(&#39;sd_generate_pinned&#39;)\npaintings = saved_sd_generate(full_seqs, num_images=1, steps=50)\n\nipyplot.plot_images(paintings)\n</pre></div>\n</div>\n<pre class=\"code-output literal-block\">INFO | 2023-02-07 16:25:41,344 | Running sd_generate_pinned via gRPC\nINFO | 2023-02-07 16:26:20,268 | Time to send message: 38.92 seconds\nWARNING | 2023-02-07 16:26:20,280 | /usr/local/lib/python3.8/dist-packages/ipyplot/_utils.py:95: FutureWarning: The input object of type 'Image' is an array-like implementing one of the corresponding protocols (<cite>__array__</cite>, <cite>__array_interface__</cite> or <cite>__array_struct__</cite>); but not a sequence (or 0-D). In the future, this object will be coerced as if it was first converted using <cite>np.array(obj)</cite>. To retain the old behaviour, you have to either modify the type 'Image', or assign to an empty array created with <cite>np.empty(correct_shape, dtype=object)</cite>.\n  return np.asarray(seq, dtype=type(seq[0]))</pre>\n<style>\n    #ipyplot-html-viewer-toggle-5ZWRVjNXFdj5TVj7x4oWfn {\n        position: absolute;\n        top: -9999px;\n        left: -9999px;\n        visibility: hidden;\n    }\n\n    #ipyplot-html-viewer-label-5ZWRVjNXFdj5TVj7x4oWfn {\n        position: relative;\n        display: inline-block;\n        cursor: pointer;\n        color: blue;\n        text-decoration: underline;\n    }\n\n    #ipyplot-html-viewer-textarea-5ZWRVjNXFdj5TVj7x4oWfn {\n        background: lightgrey;\n        width: 100%;\n        height: 0px;\n        display: none;\n    }\n\n    #ipyplot-html-viewer-toggle-5ZWRVjNXFdj5TVj7x4oWfn:checked ~ #ipyplot-html-viewer-textarea-5ZWRVjNXFdj5TVj7x4oWfn {\n        height: 200px;\n        display: block;\n    }\n\n    #ipyplot-html-viewer-toggle-5ZWRVjNXFdj5TVj7x4oWfn:checked + #ipyplot-html-viewer-label-5ZWRVjNXFdj5TVj7x4oWfn:after {\n        content: \"hide html\";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: white;\n        cursor: pointer;\n        color: blue;\n        text-decoration: underline;\n    }\n</style>\n<div>\n    <input type=\"checkbox\" id=\"ipyplot-html-viewer-toggle-5ZWRVjNXFdj5TVj7x4oWfn\">\n    <label id=\"ipyplot-html-viewer-label-5ZWRVjNXFdj5TVj7x4oWfn\" for=\"ipyplot-html-viewer-toggle-5ZWRVjNXFdj5TVj7x4oWfn\">show html</label>\n    <textarea id=\"ipyplot-html-viewer-textarea-5ZWRVjNXFdj5TVj7x4oWfn\" readonly>\n\n    <style>\n    #ipyplot-imgs-container-div-ctt8w42CeJB5xSoBbRX7Pi {\n        width: 100%;\n        height: 100%;\n        margin: 0%;\n        overflow: auto;\n        position: relative;\n        overflow-y: scroll;\n    }\n\n    div.ipyplot-placeholder-div-ctt8w42CeJB5xSoBbRX7Pi {\n        width: 150px;\n        display: inline-block;\n        margin: 3px;\n        position: relative;\n    }\n\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi {\n        width: 150px;\n        background: white;\n        display: inline-block;\n        vertical-align: top;\n        text-align: center;\n        position: relative;\n        border: 2px solid #ddd;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi span.ipyplot-img-close {\n        display: none;\n    }\n\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi span {\n        width: 100%;\n        height: 100%;\n        position: absolute;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi img {\n        width: 150px;\n    }\n\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi span.ipyplot-img-close:hover {\n        cursor: zoom-out;\n    }\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi span.ipyplot-img-expand:hover {\n        cursor: zoom-in;\n    }\n\n    div[id^=ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi]:target {\n        transform: scale(2.5);\n        transform-origin: left top;\n        z-index: 5000;\n        top: 0;\n        left: 0;\n        position: absolute;\n    }\n\n    div[id^=ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi]:target span.ipyplot-img-close {\n        display: block;\n    }\n\n    div[id^=ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi]:target span.ipyplot-img-expand {\n        display: none;\n    }\n    </style>\n<div id=\"ipyplot-imgs-container-div-ctt8w42CeJB5xSoBbRX7Pi\">\n<div class=\"ipyplot-placeholder-div-ctt8w42CeJB5xSoBbRX7Pi\">\n    <div id=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-6vBxQ9aAKu9e5dBydz3wnd\" class=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">0</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/flan_0.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-6vBxQ9aAKu9e5dBydz3wnd\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ctt8w42CeJB5xSoBbRX7Pi\">\n    <div id=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-iNHddryXJPQBpaDXBjqMxN\" class=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">1</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/flan_1.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-iNHddryXJPQBpaDXBjqMxN\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ctt8w42CeJB5xSoBbRX7Pi\">\n    <div id=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-efUNKGLZXEg2WPbtyMoNLr\" class=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">2</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/flan_2.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-efUNKGLZXEg2WPbtyMoNLr\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ctt8w42CeJB5xSoBbRX7Pi\">\n    <div id=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-MN7beZHJBF6X42xSNzZ5Gb\" class=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">3</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/flan_3.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-MN7beZHJBF6X42xSNzZ5Gb\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n</div>\n    </textarea>\n</div>    <style>\n    #ipyplot-imgs-container-div-ctt8w42CeJB5xSoBbRX7Pi {\n        width: 100%;\n        height: 100%;\n        margin: 0%;\n        overflow: auto;\n        position: relative;\n        overflow-y: scroll;\n    }\n\n    div.ipyplot-placeholder-div-ctt8w42CeJB5xSoBbRX7Pi {\n        width: 150px;\n        display: inline-block;\n        margin: 3px;\n        position: relative;\n    }\n\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi {\n        width: 150px;\n        background: white;\n        display: inline-block;\n        vertical-align: top;\n        text-align: center;\n        position: relative;\n        border: 2px solid #ddd;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi span.ipyplot-img-close {\n        display: none;\n    }\n\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi span {\n        width: 100%;\n        height: 100%;\n        position: absolute;\n        top: 0;\n        left: 0;\n    }\n\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi img {\n        width: 150px;\n    }\n\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi span.ipyplot-img-close:hover {\n        cursor: zoom-out;\n    }\n    div.ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi span.ipyplot-img-expand:hover {\n        cursor: zoom-in;\n    }\n\n    div[id^=ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi]:target {\n        transform: scale(2.5);\n        transform-origin: left top;\n        z-index: 5000;\n        top: 0;\n        left: 0;\n        position: absolute;\n    }\n\n    div[id^=ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi]:target span.ipyplot-img-close {\n        display: block;\n    }\n\n    div[id^=ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi]:target span.ipyplot-img-expand {\n        display: none;\n    }\n    </style>\n<div id=\"ipyplot-imgs-container-div-ctt8w42CeJB5xSoBbRX7Pi\">\n<div class=\"ipyplot-placeholder-div-ctt8w42CeJB5xSoBbRX7Pi\">\n    <div id=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-6vBxQ9aAKu9e5dBydz3wnd\" class=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">0</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/flan_0.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-6vBxQ9aAKu9e5dBydz3wnd\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ctt8w42CeJB5xSoBbRX7Pi\">\n    <div id=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-iNHddryXJPQBpaDXBjqMxN\" class=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">1</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/flan_1.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-iNHddryXJPQBpaDXBjqMxN\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ctt8w42CeJB5xSoBbRX7Pi\">\n    <div id=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-efUNKGLZXEg2WPbtyMoNLr\" class=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">2</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/flan_2.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-efUNKGLZXEg2WPbtyMoNLr\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n\n<div class=\"ipyplot-placeholder-div-ctt8w42CeJB5xSoBbRX7Pi\">\n    <div id=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-MN7beZHJBF6X42xSNzZ5Gb\" class=\"ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi\">\n        <h4 style=\"font-size: 12px; word-wrap: break-word;\">3</h4>\n        <img src=\"https://runhouse-tutorials.s3.amazonaws.com/flan_3.png\"/>\n        <a href=\"#!\">\n            <span class=\"ipyplot-img-close\"/>\n        </a>\n        <a href=\"#ipyplot-content-div-ctt8w42CeJB5xSoBbRX7Pi-MN7beZHJBF6X42xSNzZ5Gb\">\n            <span class=\"ipyplot-img-expand\"/>\n        </a>\n    </div>\n</div>\n</div></section>\n</section>\n\n    <script type=\"text/x-thebe-config\">\n    {\n        requestKernel: true,\n        binderOptions: {\n            repo: \"binder-examples/jupyter-stacks-datascience\",\n            ref: \"master\",\n        },\n        codeMirrorConfig: {\n            theme: \"abcdef\",\n            mode: \"python\"\n        },\n        kernelOptions: {\n            name: \"python3\",\n            path: \"./tutorials/examples\"\n        },\n        predefinedOutput: true\n    }\n    </script>\n    <script>kernelName = 'python3'</script>", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"], ["tutorials/examples/training", "Training: Transformers", "N", "next"], ["api/cli", "Command Line Interface", "P", "previous"]], "sourcename": "tutorials/examples/inference.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Inference: Stable Diffusion and FLAN-T5</a><ul>\n<li><a class=\"reference internal\" href=\"#table-of-contents\">Table of Contents</a></li>\n<li><a class=\"reference internal\" href=\"#hardware-setup\">Hardware Setup</a><ul>\n<li><a class=\"reference internal\" href=\"#install-runhouse\">Install Runhouse</a></li>\n<li><a class=\"reference internal\" href=\"#optional-login-to-runhouse-to-load-in-secrets\">[Optional] Login to Runhouse to load in secrets</a></li>\n<li><a class=\"reference internal\" href=\"#set-up-runhouse-cluster\">Set up Runhouse cluster</a></li>\n</ul>\n</li>\n<li><a class=\"reference internal\" href=\"#stable-diffusion-on-a-cloud-gpu-in-5-lines-of-code\">Stable Diffusion on a Cloud GPU in 5 lines of code</a></li>\n<li><a class=\"reference internal\" href=\"#faster-stable-diffusion\">Faster Stable Diffusion</a><ul>\n<li><a class=\"reference internal\" href=\"#load-retrieve-from-object-store\">Load/Retrieve from Object Store</a></li>\n<li><a class=\"reference internal\" href=\"#runhouse-module\">Runhouse Module</a></li>\n</ul>\n</li>\n<li><a class=\"reference internal\" href=\"#flan-t5-stable-diffusion\">FLAN-T5 Stable Diffusion</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "globaltoc": "<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">Getting Started</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/quick_start/\">Quick Start Guide</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"architecture/\">Architecture Overview</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"api_tutorials/\">API Tutorials</a><ul>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"tutorials/api/compute/\">Compute: Clusters, Functions, Packages, &amp; Envs</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"tutorials/api/data/\">Data: Folders, Tables, &amp; Blobs</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"tutorials/api/accessibility/\">Accessibility: Resource and Secrets Management</a></li>\n</ul>\n</li>\n</ul>\n<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">API Reference</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"api/python/\">Python API</a><ul>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/resource/\">Resource</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/function/\">Function</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/cluster/\">Cluster</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/env/\">Env</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/package/\">Package</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/run/\">Run</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/module/\">Module</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/folder/\">Folder</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/table/\">Table</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/blob/\">Blob</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/secrets/\">Secrets</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/login/\">Login/Logout</a></li>\n</ul>\n</li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"api/cli/\">Command Line Interface</a></li>\n</ul>\n<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">Usage Examples</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/examples/inference/\">Inference: Stable Diffusion and FLAN-T5</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/examples/training/\">Training: Transformers</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/examples/distributed/\">Distributed: HF Accelerate</a></li>\n<li class=\"toctree-l1\"><a class=\"reference external\" href=\"https://github.com/run-house/funhouse/tree/main/bert_pipeline\">Pipelining: BERT</a></li>\n</ul>\n<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">Additional Resources</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"debugging_logging/\">Debugging and Logging</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"troubleshooting/\">Manual Setup and Troubleshooting</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"auth_and_data_collection/\">Security and Authentication</a></li>\n<li class=\"toctree-l1\"><a class=\"reference external\" href=\"https://github.com/run-house/runhouse\">Source Code</a></li>\n<li class=\"toctree-l1\"><a class=\"reference external\" href=\"https://api.run.house/docs\">REST API Guide</a></li>\n<li class=\"toctree-l1\"><a class=\"reference external\" href=\"https://www.run.house/dashboard\">Dashboard</a></li>\n<li class=\"toctree-l1\"><a class=\"reference external\" href=\"https://github.com/run-house/funhouse\">Funhouse</a></li>\n</ul>\n", "current_page_name": "tutorials/examples/inference", "sidebars": ["about.html", "navigation.html", "relations.html", "searchbox.html", "donate.html"], "customsidebar": null, "alabaster_version": "0.7.13"}