{"parents": [], "prev": {"link": "../debugging-logging/", "title": "Debugging and Logging"}, "next": {"link": "../troubleshooting/", "title": "Manual Setup and Troubleshooting"}, "title": "Docker Runtime Env for On-Demand Clusters", "meta": {}, "body": "<section id=\"docker-runtime-env-for-on-demand-clusters\">\n<h1>Docker Runtime Env for On-Demand Clusters<a class=\"headerlink\" href=\"#docker-runtime-env-for-on-demand-clusters\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>Runhouse integrates with\n<a class=\"reference external\" href=\"https://skypilot.readthedocs.io/en/latest/docs/index.html\">SkyPilot</a>\nto enable automatic setup of an existing Docker container when you\nlaunch your <a class=\"reference external\" href=\"https://www.run.house/docs/api/python/cluster#ondemandcluster-class\">on-demand\ncluster</a>.\nWhen you specify a Docker image for an on-demand cluster, the container\nis automatically built and set up remotely on the cluster. The Runhouse\nserver will start directly inside the remote container.</p>\n<p><strong>NOTE:</strong> This guide details the setup and usage for on-demand clusters\nonly. Docker container is also supported for Sagemaker clusters, and it\nis not yet supported for static clusters.</p>\n<section id=\"cluster-docker-setup\">\n<h2>Cluster &amp; Docker Setup<a class=\"headerlink\" href=\"#cluster-docker-setup\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p><strong>NOTE:</strong> Docker support for on-demand clusters is currently an Alpha\nfeature. The syntax and setup is subject to change, and this page will\nbe updated with any changes.</p>\n<section id=\"public-docker-image\">\n<h3>Public Docker Image<a class=\"headerlink\" href=\"#public-docker-image\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<p>To specify the Docker container, pass it to the <code class=\"docutils literal notranslate\"><span class=\"pre\">image_id</span></code> field of\nthe ondemand_cluster factory, in the following format:\n<code class=\"docutils literal notranslate\"><span class=\"pre\">docker:&lt;registry&gt;/&lt;image&gt;:&lt;tag&gt;</span></code>.</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>docker_cluster = rh.ondemand_cluster(\n    name=&quot;pytorch_cluster&quot;,\n    image_id=&quot;docker:nvcr.io/nvidia/pytorch:23.10-py3&quot;,\n    instance_type=&quot;CPU:2+&quot;,\n    provider=&quot;aws&quot;,\n)\n</pre></div>\n</div>\n</section>\n<section id=\"private-docker-image\">\n<h3>Private Docker Image<a class=\"headerlink\" href=\"#private-docker-image\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<p>To use a Docker image hosted on a private registry, such as ECR, you\nneed to pass in the following environment variables. These environment\nvariables will propogate through to SkyPilot, which will use them while\nlaunching and setting up the cluster and base container.</p>\n<p>Values used in:\n<code class=\"docutils literal notranslate\"><span class=\"pre\">docker</span> <span class=\"pre\">login</span> <span class=\"pre\">-u</span> <span class=\"pre\">&lt;user&gt;</span> <span class=\"pre\">-p</span> <span class=\"pre\">&lt;password&gt;</span> <span class=\"pre\">&lt;registry</span> <span class=\"pre\">server&gt;</span></code>: *\nSKYPILOT_DOCKER_USERNAME: <code class=\"docutils literal notranslate\"><span class=\"pre\">&lt;user&gt;</span></code> * SKYPILOT_DOCKER_PASSWORD:\n<code class=\"docutils literal notranslate\"><span class=\"pre\">&lt;password&gt;</span></code> * SKYPILOT_DOCKER_SERVER: <code class=\"docutils literal notranslate\"><span class=\"pre\">&lt;registry</span> <span class=\"pre\">server&gt;</span></code></p>\n<p>For instance, to use the PyTorch2.2 ECR Framework provided\n<a class=\"reference external\" href=\"https://github.com/aws/deep-learning-containers/blob/master/available_images.md#ec2-framework-containers-tested-on-ec2-ecs-and-eks-only\">here</a>,\nyou must first set your environment variables somewhere your program can\naccess.</p>\n<div class=\"highlight-cli notranslate\"><div class=\"highlight\"><pre><span></span>export SKYPILOT_DOCKER_USERNAME=AWS\nexport SKYPILOT_DOCKER_PASSWORD=$(aws ecr get-login-password --region us-east-1)\nexport SKYPILOT_DOCKER_SERVER=763104351884.dkr.ecr.us-east-1.amazonaws.com\n</pre></div>\n</div>\n<p>Then, instantiate the on-demand cluster and fill in the <code class=\"docutils literal notranslate\"><span class=\"pre\">image_id</span></code>\nfield.</p>\n<div class=\"highlight-ipython3 notranslate\"><div class=\"highlight\"><pre><span></span>ecr_cluster = rh.ondemand_cluster(\n    name=&quot;ecr_pytorch_cluster&quot;,\n    image_id=&quot;docker:pytorch-training:2.2.0-cpu-py310-ubuntu20.04-ec2&quot;,\n    instance_type=&quot;CPU:2+&quot;,\n    provider=&quot;aws&quot;,\n)\n</pre></div>\n</div>\n<section id=\"launching-the-cluster\">\n<h4>Launching the Cluster<a class=\"headerlink\" href=\"#launching-the-cluster\" title=\"Permalink to this heading\">\u00b6</a></h4>\n<p>You can then launch the docker cluster with <code class=\"docutils literal notranslate\"><span class=\"pre\">ecr_cluster.up()</span></code>. If for\nany reason the docker pull fails on the cluster (for instance, due to\nincorrect credentials or permission error), you must first teardown the\ncluster with <code class=\"docutils literal notranslate\"><span class=\"pre\">ecr_cluster.teardown()</span></code> or\n<code class=\"docutils literal notranslate\"><span class=\"pre\">sky</span> <span class=\"pre\">stop</span> <span class=\"pre\">ecr_pytorch_cluster</span></code> in CLI before re-launching the cluster\nwith new credentials in order for them to propogate through.</p>\n</section>\n</section>\n</section>\n<section id=\"advanced-usage-and-details\">\n<h2>Advanced Usage and Details<a class=\"headerlink\" href=\"#advanced-usage-and-details\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p>When the cluster is launched, the Docker container is set up on the\ncluster. SkyPilot will be set up in it\u2019s own separate base Conda\nenvironment, while Runhouse will be installed and the server set up\ndirectly on the Docker container. This way, any commands or\nfunctions/classes run through Runhouse will be run directly on the\ncontainer, with access to any of its dependencies and setup.</p>\n<section id=\"ssh\">\n<h3>SSH<a class=\"headerlink\" href=\"#ssh\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<p>To SSH directly onto the container, where the Runhouse server is\nstarted, you can use <code class=\"docutils literal notranslate\"><span class=\"pre\">runhouse</span> <span class=\"pre\">ssh</span> <span class=\"pre\">&lt;cluster_name&gt;</span></code>.</p>\n<p>If you simply use <code class=\"docutils literal notranslate\"><span class=\"pre\">ssh</span> <span class=\"pre\">&lt;cluster_name&gt;</span></code>, the base environment set up by\nSkyPilot will be activated by default. In this case, you would need to\nadditionally call <code class=\"docutils literal notranslate\"><span class=\"pre\">conda</span> <span class=\"pre\">deactivate</span></code> to land in the base Docker\ncontainer.</p>\n</section>\n<section id=\"user-and-container-name\">\n<h3>User and Container Name<a class=\"headerlink\" href=\"#user-and-container-name\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<p>By default, the remote Docker container, which is set up through\nSkypilot, will be named <code class=\"docutils literal notranslate\"><span class=\"pre\">sky_container</span></code>, and the user will be\n<code class=\"docutils literal notranslate\"><span class=\"pre\">root</span></code>.</p>\n</section>\n</section>\n</section>\n\n    <script type=\"text/x-thebe-config\">\n    {\n        requestKernel: true,\n        binderOptions: {\n            repo: \"binder-examples/jupyter-stacks-datascience\",\n            ref: \"master\",\n        },\n        codeMirrorConfig: {\n            theme: \"abcdef\",\n            mode: \"python\"\n        },\n        kernelOptions: {\n            name: \"python3\",\n            path: \"./.\"\n        },\n        predefinedOutput: true\n    }\n    </script>\n    <script>kernelName = 'python3'</script>", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"], ["troubleshooting", "Manual Setup and Troubleshooting", "N", "next"], ["debugging-logging", "Debugging and Logging", "P", "previous"]], "sourcename": "docker.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Docker Runtime Env for On-Demand Clusters</a><ul>\n<li><a class=\"reference internal\" href=\"#cluster-docker-setup\">Cluster &amp; Docker Setup</a><ul>\n<li><a class=\"reference internal\" href=\"#public-docker-image\">Public Docker Image</a></li>\n<li><a class=\"reference internal\" href=\"#private-docker-image\">Private Docker Image</a><ul>\n<li><a class=\"reference internal\" href=\"#launching-the-cluster\">Launching the Cluster</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a class=\"reference internal\" href=\"#advanced-usage-and-details\">Advanced Usage and Details</a><ul>\n<li><a class=\"reference internal\" href=\"#ssh\">SSH</a></li>\n<li><a class=\"reference internal\" href=\"#user-and-container-name\">User and Container Name</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "globaltoc": "<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">Getting Started</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/quick-start-cloud/\">Cloud Quick Start</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/quick-start-local/\">Local Quick Start</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/quick-start-den/\">Den Quick Start</a></li>\n</ul>\n<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">API Basics</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-clusters/\">Clusters</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-modules/\">Functions and Modules</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-envs/\">Envs and Packages</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-folders/\">Folders</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-secrets/\">Secrets</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/api-resources/\">Resource Management</a></li>\n</ul>\n<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">API Reference</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"api/python/\">Python API</a><ul>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/resource/\">Resource</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/function/\">Function</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/cluster/\">Cluster</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/env/\">Env</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/package/\">Package</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/module/\">Module</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/mapper/\">Mapper</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/folder/\">Folder</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/table/\">Table</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/blob/\">Blob</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/file/\">File</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/secrets/\">Secrets</a></li>\n<li class=\"toctree-l2\"><a class=\"reference internal\" href=\"api/python/login/\">Login/Logout</a></li>\n</ul>\n</li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"api/cli/\">Command Line Interface</a></li>\n</ul>\n<p class=\"caption\" role=\"heading\"><span class=\"caption-text\">Other Topics</span></p>\n<ul>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"tutorials/async/\">Asynchronous Programming</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"architecture/\">Architecture Overview</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"debugging-logging/\">Debugging and Logging</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"docker/\">Docker Runtime Env for On-Demand Clusters</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"troubleshooting/\">Manual Setup and Troubleshooting</a></li>\n<li class=\"toctree-l1\"><a class=\"reference internal\" href=\"security-and-authentication/\">Security and Authentication</a></li>\n</ul>\n", "current_page_name": "docker", "sidebars": ["about.html", "navigation.html", "relations.html", "searchbox.html", "donate.html"], "customsidebar": null, "alabaster_version": "0.7.16", "alabaster_version_info": [0, 7, 16]}